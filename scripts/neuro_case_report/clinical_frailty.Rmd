---
title: "Clinical frailty score - COVID CNS"
author: "Helena Davies"
date: "19/01/2022"
output: html_document
---

Configure global options for all chunks
```{r Setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = '',
  prompt = FALSE,
  cache = FALSE
  )
```

Clear global environment prior to initiation
```{r Clear global environment}
remove(list = ls())
```

Add the add_numeric function - used to convert character variables into numeric variables.
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
```{r Read in functions}
 source(file = "../functions/add_numeric.R")
 source(file = "../functions/remove_duplicates.R")
 source(file = "../functions/sumscores.R")
 source(file = "../functions/package_check.R")
 source(file = "../functions/imp_check.R")
```

Use package_check to install and load dependencies
Load tidyverse last
```{r Install load dependencies}
packages <- c(
  "summarytools", 
  "sjlabelled", 
  "Amelia", 
  "gtsummary", 
  "tidyverse"
  )
package_check(packages)
```

Retrieve recent date
We are using the recent date to save files with paste0() as an extension to not overwrite old versions
```{r Recent date}
date <- Sys.Date()
date
```

Read in file with path to ilovedata channel on Teams
```{r Read in file with path to ilovedata channel on teams}
source(file = "../credentials/paths.R")
```

# Read in the data: Demographics
## CNS data
```{r CNS read in data}
cns_data <- readRDS(
  file = paste0(ilovedata, "/data_raw/latest_freeze/covid_cns/neuro_case_report/ncrf_comorbid_covid_cns.rds")
  )


  
# Check variable names in dataframe
cns_data %>%
  colnames()
# Inspect dimensions of dataframe 
cns_data %>%
  dim()
```

Specify columns to be excluded from add_numeric function
```{r CNS specify excluded columns}
exclude_cols_numeric <- c(
  "ID",
  "sample",
  "startDate",
  "endDate"
  )
```

Select & rename relevant columns
```{r CNS select}
cns_data_id <- cns_data %>% #new dataset with ID
  drop_na(externalDataReference) %>% # Drop participants with no ID
  remove_duplicates("externalDataReference") %>% # Remove duplicate IDs
  add_column(sample = "CNS", 
             .after = "externalDataReference") %>% # Create new sample column
  select(
         ID = externalDataReference, # ID
         sample,
         startDate,
         endDate,
         ncrf_comorbid.clinical_frailty_scale
         ) %>%
  add_numeric(exclude = exclude_cols_numeric)
# Inspect colnames
cns_data_id %>%
  colnames()
```

Look at number of people excluded
```{r CNS number excluded}
# Inspect dimensions of new data set
cns_data_id %>%
  dim()
# Inspect number of rows dropped
cns_excluded <- dim(cns_data_id)[1] - dim(cns_data)[1]
cns_excluded
```

Inspect numeric variables
```{r CNS inspect numeric variables}
cns_data_id %>%
  select(all_of(ends_with("numeric"))) %>%
  tbl_summary(missing_text = "Missing")
```

Check missingness by missmap
```{r CNS inspect missingness}
 cns_miss_map <- cns_data_id %>% 
   missmap()
 cns_miss_map
```

Rename data for cleaning
```{r Rename data set}
dat <- cns_data_id
#Check
dat %>% glimpse()
```

Recode Non-answer values to 3 digits
-555 'Not applicable' response from participant
-777 Seen but not answered
-888 Don't know
-999 Prefer not to answer/Prefer not to say
`NA` Were not shown the question (genuinely missing value)
When we code someone as being 'not applicable' by deduction, we use `NA_real_`
```{r Recode NA values}
dat <- dat %>%
  mutate(across(ends_with("numeric"),
                ~case_when(
                  . == -55 ~ -555,
                  . == -77 ~ -777,
                  . == -88 ~ -888,
                  . == -99 ~ -999,
                  TRUE ~ .)))
```

# Clinical frailty: Numeric version, 1-9 
Cleaning numeric variables
```{r vector of numeric values}
values_numeric_1_to_9 <- c(
  1,
  2,
  3,
  4,
  5,
  6,
  7,
  8,
  9,
  -777,
  NA
  )
values_numeric_1_to_9
```

Create vector of variable names for numeric variables
```{r vector numeric variables}
variables_numeric_1_to_9 <- c(
    "ncrf_comorbid.clinical_frailty_scale_numeric"
  )
variables_numeric_1_to_9
```

Use imp_check function to find if any implausible values and obtain summary table of variables
```{r imp_check numeric variables}
imp_check(data = dat,
           variables = variables_numeric_1_to_9,
          values = values_numeric_1_to_9)
```
NB: 19/01/22 - The max clinical frailty score in this sample is 7.

# Clinical frailty: Categorical version
Create vector of categorical values for variables
```{r vector of categorical labels}
values_categorical_clinical_frailty <- c(
  "Very fit",
"Fit",
"Managing well",
"Living with very mild frailty",
"Living with mild frailty",
"Living wiht moderate frailty",
"Living with severe frailty",
"Living with very severe Frailty",
"Terminally ill",
"Seen but not answered",
  NA
  )
values_categorical_clinical_frailty
```

Create vector of variable names
```{r vector categorical variables}
variables_categorical_clinical_frailty<- c(
    "ncrf_comorbid.clinical_frailty_scale"
  )
variables_categorical_clinical_frailty
```

Use imp_check function to find if any implausible values and obtain summary table of variables
```{r imp_check categorical variables}
imp_check(data = dat,
           variables = variables_categorical_clinical_frailty,
          values = values_categorical_clinical_frailty)
```

# Save cleaned data
Check colnames before exporting final dataset
```{r check colnames}
colnames(dat)
```

Combined object for excluded participants
```{r CNS EDGI save excluded participants}
cns_excluded <- as.data.frame(cns_excluded)
colnames(cns_excluded) <- c("Number of Participants Excluded")
rownames(cns_excluded) <- c("CNS")
cns_excluded
```

# CNS
```{r Write cleaned CNS variables to a .rds file}
dat %>% 
 saveRDS(
    file = paste0(ilovedata, "/data/latest_freeze/covidcns/ncrf_clinical_frailty_clean.rds")
    )
```