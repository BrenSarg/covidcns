---
title: "Language (Covid CNS)"
author: "Abigail ter Kuile"
date: "31/01/2022"
output:
  pdf_document: default
  html_document: default
---

# Set up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)
```

## Delete everything in your global environment
```{r Delete everything in your global environment}
remove(list = ls())
```

Add the add_numeric function - used to convert character variables into numeric variables.
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
```{r Read in functions}
source(file = "scripts/functions/add_numeric_1.R")
source(file = "scripts/functions/remove_duplicates.R")
source(file = "scripts/functions/sumscores.R")
source(file = "scripts/functions/package_check.R")
source(file = "scripts/functions/imp_check.R")
```

Note: always load tidyverse last
```{r Install load dependencies}
packages = c(
  "summarytools",
  "sjlabelled",
  "Amelia",
  "gtsummary",
  "tidyverse"
  )
package_check(packages)
```

## Retrieve the recent date
We are using the recent date to save files with paste0() as an extension to not overwrite old versions
```{r Recent date}
date = Sys.Date()
date
```

## Read in file with path to ilovecovidcns channel on Teams
```{r Read in file with path to ilovecovidcns channel on Teams}
source(file = "scripts/credentials/paths.R")
```

# Read in the data: Demographics

## COVID CNS data
```{r COVID CNS read in data}
covidcns_dat <- read_rds(
  file = paste0(ilovecovidcns, "/data_raw/latest_freeze/baseline/dem_covid_cns.rds")
  )
  
# check variable names in dataframe
covidcns_dat %>%
  colnames()
# Inspect dimensions of dataframe (number of rows and columns)
covidcns_dat %>%
  dim()
```

Specify columns to be excluded from add_numeric function
Continuous variables should be excluded, as they are already numeric
NB: If this is data from the COPING survey, add "_cop" to the end of each variable name
```{r COVID CNS specify excluded columns}
exclude_cols_numeric <- c(
  "ID",
  "sample",
  "startDate",
  "endDate",
  "dem.what_is_your_first_language.txt"
  )
```

Select & rename relevant columns (will be a function at some point)
```{r COVID CNS select & rename relevant columns}
covidcns_dat_id <- covidcns_dat %>% # new dataset with ID
  drop_na(externalDataReference) %>% # Drop participants with no ID
  distinct(externalDataReference, .keep_all = TRUE) %>% # Changed to distinct due to NA coercion
  add_column(sample = "COVIDCNS", 
             .after = "externalDataReference") %>% # Create new sample column
  select(
         ID = externalDataReference,# ID
         sample,
         startDate,
         endDate,
         dem.what_is_your_first_language,
         dem.what_is_your_first_language.txt,
         dem.is_english_your_first_language
         )  %>% 
   
 add_numeric_1(exclude = exclude_cols_numeric)
 
# Inspect colnames
covidcns_dat_id %>%
  colnames()
```

Look at number of people excluded
```{r COVID CNS number excluded}
# Inspect dimensions of new data set
covidcns_dat_id %>%
  dim()
# Inspect number of rows dropped
covidcns_excluded <- dim(covidcns_dat_id)[1]-dim(covidcns_dat)[1]
covidcns_excluded
```

Inspect numeric variables
```{r COVID CNS inspect numeric variables}
covidcns_dat_id %>%
  select(all_of(ends_with("numeric"))) %>%
  tbl_summary(missing_text = "Missing")
```

Check missingness by missmap
```{r COVID CNS inspect missingness}
 covidcns_miss_map <- covidcns_dat_id %>% 
   missmap()
 covidcns_miss_map
```

Rename covidcns_dat_id to dat
```{r Rename covidcns_dat_id to dat}
dat <- covidcns_dat_id
```


# Data cleaning 

Recode Non-answer values to 3 digits
-555 'Not applicable' response from participant
-777 Seen but not answered
-888 Don't know
-999 Prefer not to answer/Prefer not to say
`NA` Were not shown the question (genuinely missing value)
When we code someone as being 'not applicable' by deduction, we use `NA_real_`
```{r Recode NA values}
dat <- dat %>%
  mutate(across(ends_with("numeric"),
                ~case_when(
                  . == -55 ~ -555,
                  . == -77 ~ -777,
                  . == -88 ~ -888,
                  . == -99 ~ -999,
                  TRUE ~ .)))
```

# Cleaning numeric variables

# Numeric 1-24 variables

Note: English as first language is asked as a separate question. dem.what_is_your_first_language is coded 1-4 and 6-24 (5 is missing - which should be English)
Recode English as 5 under dem.what_is_your_first_language
```{r add English first language to dem.what_is_your_first_language_numeric}
dat <- dat %>%
  mutate(
    dem.what_is_your_first_language_numeric = 
      if_else(
        dem.is_english_your_first_language_numeric == 1,
        true = 5,
        false = dem.what_is_your_first_language_numeric,
        missing = NA_real_
      )
  )

#check 
dat %>% 
  select(dem.is_english_your_first_language_numeric,
         dem.what_is_your_first_language_numeric)
```

Cleaning numeric variables
```{r vector of numeric values 1_24}
values_numeric_24 <- c(
  1,
  2,
  3,
  4,
  5,
  6,
  7,
  8,
  9,
  10,
  11,
  12,
  13,
  14,
  15,
  16,
  17,
  18,
  19,
  20,
  21,
  22,
  23,
  24,
  -777,
  NA
  )
values_numeric_24
```

Create vector of variable names for numeric variables
```{r vector numeric variables _24}
variables_numeric_24 <- c(
    "dem.what_is_your_first_language_numeric"
  )
variables_numeric_24
```

Use imp_check function to find if any implausible values and obtain summary table of variables
```{r imp_check numeric variables _24}
imp_check(data = dat,
          variables = variables_numeric_24,
          values = values_numeric_24)
```
# Numeric 0-1 variables

Cleaning numeric variables
```{r vector of numeric values 0}
values_numeric_0 <- c(
  0,
  1,
  -999,
  NA
  )
values_numeric_0
```

Create vector of variable names for numeric variables
```{r vector numeric variables 0}
variables_numeric_0 <- c(
    "dem.is_english_your_first_language_numeric"
  )
variables_numeric_0
```

Use imp_check function to find if any implausible values and obtain summary table of variables
```{r imp_check numeric variables 0}
imp_check(data = dat,
           variables = variables_numeric_0,
          values = values_numeric_0)
```

# Cleaning Categorical variables

# Categorical variables 1-24

Add categorical label "English" to dem.what_is_your_first_language
```{r add English first language to dem.what_is_your_first_language categorical label}
dat <- dat %>%
  mutate(
    dem.what_is_your_first_language = 
      case_when(
        dem.what_is_your_first_language_numeric == 5 ~ "English",
        TRUE ~ as.character(dem.what_is_your_first_language)
      )
  )
#check 
dat %>% 
  select(dem.what_is_your_first_language,
         dem.what_is_your_first_language_numeric)
```

Create vector of categorical values for variables
```{r vector categorical values 24}
values_categorical_24 <- c(
  "Arabic",
  "Bengali",
  "Chinese",
  "Danish",
  "English",
  "French",
  "Gaelic",
  "German",
  "Hindi",
  "Japanese",
  "Javanese",
  "Korean",
  "Lahnda",
  "Mandarin",
  "Polish",
  "Portuguese",
  "Punjabi",
  "Russian",
  "Spanish",
  "Tamil",
  "Turkish",
  "Vietnamese",
  "Welsh",
  "Other",
  "Seen but not answered",
  NA
  )
values_categorical_24
```

Create vector of variable names for categorical variables
```{r vector categorical variables 24}
variables_categorical_24 <-
  c(
    "dem.what_is_your_first_language"
    )
variables_categorical_24
```

Use imp_check function to find if any implausible values and obtain summary table of variables
```{r imp_check categorical variables 24}
imp_check(data = dat,
          variables = variables_categorical_24,
          values = values_categorical_24)
```
# Categorical variables 0-1

Create vector of categorical values for variables
```{r vector categorical values}
values_categorical_0 <- c(
  "No",
  "Yes",
  "Prefer not to say",
  NA)
values_categorical_0
```

Create vector of variable names for categorical variables
```{r vector categorical variables}
variables_categorical_0 <-
  c(
    "dem.is_english_your_first_language"
    )
variables_categorical_0
```

Use imp_check function to find if any implausible values and obtain summary table of variables
```{r imp_check categorical variables}
imp_check(data = dat,
          variables = variables_categorical_0,
          values = values_categorical_0)
```
# Save cleaned data
Check colnames before exporting final dataset
```{r check colnames}
colnames(dat)
```

```{r Write cleaned variables to a .rds file}
dat %>% 
  filter(sample == "COVIDCNS") %>%  # select only COVID CNS participants
  saveRDS(
    file = paste0(ilovecovidcns,"/data/latest_freeze/baseline/dem_language_covidcns_clean.rds")
    )
```
