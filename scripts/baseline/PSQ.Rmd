---
title: "PSQ"
author: "Chelsea Mika Malouf"
date: "2022-10-10"
output: html_document
---

All arguments should be in their own row, including the first argument
Closing bracket should have its own row
Functions with a single argument can have this on the same line
One argument can be hashed out per line for debugging errors

Chunk names should be all lower case except capitalised first word
Chunk names MUST be unique
Points requiring user input are enclosed thus <>

Ensure that you have deleted/untracked .DS_Store before your initial commit
Ensure that your  .gitignore contains "**/.DS_Store" before your initial commit

Configure global options for all chunks
```{r Setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = '',
  prompt = FALSE,
  cache = FALSE
  )
```

Clear global environment prior to initiation
```{r Clear global environment}
remove(list = ls())
```

Add the add_labelled_numeric function - used to convert character variables into numeric variables
Add the remove_duplicates function - used to deduplicate and remove NAs from IDs
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
Add the recode_check function - used to check for implausible values when recoding
Add the imp_clean function - used to check variables for implausible values
Add the cont_clean function - used to check continuous variables for implausible values
```{r Read in functions}
source(file = "scripts/functions/add_labelled_numeric.R")
source(file = "scripts/functions/remove_duplicates.R")
source(file = "scripts/functions/sumscores.R")
source(file = "scripts/functions/package_check.R")
source(file = "scripts/functions/recode_check.R")
source(file = "scripts/functions/cont_clean.R")
```

Use package_check to install and load dependencies
Load tidyverse last
```{r Install load dependencies}
packages <- c("sjlabelled",
              "Amelia",
              "gtsummary",
              "tidyverse"
              )

package_check(packages)
```

Read in file with path to ilovecovidcns channel on Teams
Ensure that your credentials directory is correctly located
```{r Source filepath to ilovecovidcns OneDrive}
source(file = "scripts/credentials/paths.R")
```

# Read in the data: <Full Name of Questionnaire/Demographic>

Do not change variable names from the NLP names that are produced by the extraction
EXCEPT in exceptional circumstances
Document ANY changes to variable names in the Teams Data Issues Tracker

- For variable names, use ONLY 'questionnaire.variable_name' syntax
- When using pipe operator '%>%', each function should begin on a new line for clarity
- Do not add empty lines at the beginning or end of a chunk to keep the markdown as short as possible
- Use only tidyverse functions wherever possible, they run faster than base R

COVIDCNS data
```{r COVIDCNS load data}
covidcns_dat <- read_rds(
  file = paste0(ilovecovidcns, "/data_raw/latest_freeze/baseline/psq_covid_cns.rds")
  )
  
# Check variable names in dataframe
covidcns_dat %>%
  colnames()

# Inspect dimensions of dataframe 
covidcns_dat %>%
  dim()

# Report counts of duplicates in ID column
covidcns_dat %>%
  select(externalDataReference) %>%
  filter(duplicated(.)) %>%
  count(., externalDataReference)

# Report number of IDs to be dropped
covidcns_excluded <- covidcns_dat %>%
  select(externalDataReference) %>%
  filter(duplicated(.)) %>%
  count(., externalDataReference) %>%
  select("Dropped IDs" = "n") %>%
  colSums() + 1

covidcns_excluded
```

Create new df with renamed and de-duplicated/NA-removed ID column
```{r COVIDCNS select}
covidcns_dat_id <- covidcns_dat %>% #new dataset with ID
  remove_duplicates("externalDataReference") %>% # Remove duplicate IDs
  dplyr::rename(
    "ID" = "externalDataReference"
  )

# Inspect colnames
covidcns_dat_id %>%
  colnames()

# Inspect dimensions of new data set
covidcns_dat_id %>%
  dim()
```

Check missingness by missmap
```{r COVIDCNS missmap}
covidcns_dat_id %>% 
  missmap()
```

Create dat as copy of covidcns_dat_id for brevity
This step gives you a 'reset' point: if your variable recoding screws up, re-run this chunk to give you a fresh 'dat' dataframe
```{r Create dat}
dat <- covidcns_dat_id 
```

Extract and save labels
```{r Extract save labels}
# Save variable labels
question_labels <- sjlabelled::get_label(dat)

# Save value labels
answer_labels <- sjlabelled::get_labels(dat, values = "as.name")

# Change -77 to -777 in value labels names
chng <- rapply(sapply(answer_labels, names),
               function(x) ifelse(x==-77, -777, x),
               how = "replace")

# Add multiple lines here as necessary to change other nonanswer values in labels
# chng <- rapply(chng,
#                function(x) ifelse(x==-88, -888, x),
#                how = "replace")

# Substitute new value labels into answer_labels
for (i in 1:length(chng)){
  if(!is.null(answer_labels[[i]])){
  names(answer_labels[[i]]) <- chng[[i]]
  }
}
```

Recode Non-answer values to 3 digits
-555 'Not applicable' response from participant
-777 Seen but not answered
-888 Don't know
-999 Prefer not to answer/Prefer not to say
`NA` Were not shown the question (genuinely missing value)
When we code someone as being 'not applicable' by deduction, we use `NA_real_`
```{r Recode NA values}
dat <- dat %>%
  mutate(across(where(is.numeric),
                ~case_when(
                  . == -55 ~ -555,
                  . == -77 ~ -777,
                  . == -88 ~ -888,
                  . == -99 ~ -999,
                  TRUE ~ .)
                )
         )

# Re-add labels after mutate
dat <- sjlabelled::set_label(dat, question_labels)
dat <- sjlabelled::set_labels(dat, labels = answer_labels)
```

Create list of all labels and attributes
This chunk supersedes all categorical/numeric cleaning
It gives you an output of c(the question label, all value-label pairs)
for each variable
Check for errors in the output of this chunk, including:
- Label spelling errors (for questions and answers)
- Incorrect values
- Mismatches between labels and values
- Scale errors
- Variable naming issues from the data extraction
- Any other issues you can see
All issues/changes need to be logged as a to-do on Teams
At this point, you also need to pick out any continuous, date or text variables 
to be cleaned in the later chunks
```{r List labels attrs}
label_list <- sapply(dat, function(x) c(attr(x, "label"), attr(x, "labels")))
label_list
```


# Rectifying Incorrect Variable Labelling

Check psq.break_end_happy_felt labels
"Dont know" is not coded correctly. Was originally "unsure"
```{r Check psq.break_end_happy_felt labelling}
dat %>%
  select(psq.break_end_happy_felt) %>%
  str()
```

Rename value labels of psq.break_end_happy_felt
```{r Rename psq.break_end_happy_felt value labels}
# Named vector of correct labels
new_levels_vec <- c(
  "Don't know" = -888,
  "Seen but not answered" = -777,
  "No" = 0, 
  "Yes" = 1
    )

# Assign new labels
dat$psq.break_end_happy_felt <- set_labels(dat$psq.break_end_happy_felt, labels = new_levels_vec)

# Remove labels vector
rm(new_levels_vec)
```

Recheck psq.break_end_happy_felt labelling
```{r Recheck psq.break_end_happy_felt labelling}
dat %>%
  select(psq.break_end_happy_felt) %>%
  str()
```



Check psq.was_there_an_obvious_reason_for_this labels
"Dont know" is not coded correctly. Was originally "unsure"
```{r Check psq.was_there_an_obvious_reason_for_this labelling}
dat %>%
  select(psq.was_there_an_obvious_reason_for_this) %>%
  str()
```

Rename value labels of psq.was_there_an_obvious_reason_for_this
```{r Rename psq.was_there_an_obvious_reason_for_this value labels}
# Named vector of correct labels
new_levels_vec <- c(
  "Don't know" = -888,
  "Seen but not answered" = -777,
  "No" = 0, 
  "Yes" = 1
    )

# Assign new labels
dat$psq.was_there_an_obvious_reason_for_this <- set_labels(dat$psq.was_there_an_obvious_reason_for_this, labels = new_levels_vec)

# Remove labels vector
rm(new_levels_vec)
```

Recheck psq.was_there_an_obvious_reason_for_this labelling
```{r Recheck psq.was_there_an_obvious_reason_for_this labelling}
dat %>%
  select(psq.was_there_an_obvious_reason_for_this) %>%
  str()
```



Check psq.complain_strange_people labels
"Dont know" is not coded correctly. Was originally "unsure"
```{r Check psq.complain_strange_people labelling}
dat %>%
  select(psq.complain_strange_people) %>%
  str()
```

Rename value labels of psq.complain_strange_people
```{r Rename psq.complain_strange_people value labels}
# Named vector of correct labels
new_levels_vec <- c(
  "Don't know" = -888,
  "Seen but not answered" = -777,
  "No" = 0, 
  "Yes" = 1
    )

# Assign new labels
dat$psq.complain_strange_people <- set_labels(dat$psq.complain_strange_people, labels = new_levels_vec)

# Remove labels vector
rm(new_levels_vec)
```

Recheck psq.complain_strange_people labelling
```{r Recheck psq.complain_strange_people labelling}
dat %>%
  select(psq.complain_strange_people) %>%
  str()
```



Check psq.controlled_force_person_thoughts labels
"Dont know" is not coded correctly. Was originally "unsure"
```{r Check psq.controlled_force_person_thoughts labelling}
dat %>%
  select(psq.controlled_force_person_thoughts) %>%
  str()
```

Rename value labels of psq.controlled_force_person_thoughts
```{r Rename psq.controlled_force_person_thoughts value labels}
# Named vector of correct labels
new_levels_vec <- c(
  "Don't know" = -888,
  "Seen but not answered" = -777,
  "No" = 0, 
  "Yes" = 1
    )

# Assign new labels
dat$psq.controlled_force_person_thoughts <- set_labels(dat$psq.controlled_force_person_thoughts, labels = new_levels_vec)

# Remove labels vector
rm(new_levels_vec)
```

Recheck psq.controlled_force_person_thoughts labelling
```{r Recheck psq.controlled_force_person_thoughts labelling}
dat %>%
  select(psq.controlled_force_person_thoughts) %>%
  str()

library(summarytools)

dat %>%
  freq(psq.controlled_force_person_thoughts)
```



Check psq.find_hard_instance_telepathy labels
"Dont know" is not coded correctly. Was originally "unsure"
```{r Check psq.find_hard_instance_telepathy labelling}
dat %>%
  select(psq.find_hard_instance_telepathy) %>%
  str()
```

Rename value labels of psq.find_hard_instance_telepathy
```{r Rename psq.find_hard_instance_telepathy value labels}
# Named vector of correct labels
new_levels_vec <- c(
  "Don't know" = -888,
  "Seen but not answered" = -777,
  "No" = 0, 
  "Yes" = 1
    )

# Assign new labels
dat$psq.find_hard_instance_telepathy <- set_labels(dat$psq.find_hard_instance_telepathy, labels = new_levels_vec)

# Remove labels vector
rm(new_levels_vec)
```

Recheck psq.find_hard_instance_telepathy labelling
```{r Recheck psq.find_hard_instance_telepathy labelling}
dat %>%
  select(psq.find_hard_instance_telepathy) %>%
  str()
```


Check psq.felt_times_people_past labels
"Dont know" is not coded correctly. Was originally "unsure"
```{r Check psq.felt_times_people_pastlabelling}
dat %>%
  select(psq.felt_times_people_past) %>%
  str()
```

Rename value labels of psq.felt_times_people_past 
```{r Rename psq.felt_times_people_past  value labels}
# Named vector of correct labels
new_levels_vec <- c(
  "Don't know" = -888,
  "Seen but not answered" = -777,
  "No" = 0, 
  "Yes" = 1
    )

# Assign new labels
dat$psq.felt_times_people_past <- set_labels(dat$psq.felt_times_people_past, labels = new_levels_vec)

# Remove labels vector
rm(new_levels_vec)
```

Recheck psq.felt_times_people_past labelling
```{r Recheck psq.felt_times_people_past  labelling}
dat %>%
  select(psq.felt_times_people_past) %>%
  str()
```



Check psq.interests_harm_felt_times labels
"Dont know" is not coded correctly. Was originally "unsure"
```{r Check psq.felt_times_people_pastlabelling}
dat %>%
  select(psq.interests_harm_felt_times) %>%
  str()
```

Rename value labels of psq.interests_harm_felt_times
```{r Rename psq.interests_harm_felt_times value labels}
# Named vector of correct labels
new_levels_vec <- c(
  "Don't know" = -888,
  "Seen but not answered" = -777,
  "No" = 0, 
  "Yes" = 1
    )

# Assign new labels
psq.interests_harm_felt_times <- set_labels(dat$psq.interests_harm_felt_times, labels = new_levels_vec)

# Remove labels vector
rm(new_levels_vec)
```

Recheck psq.interests_harm_felt_times labelling
```{r Recheck psq.interests_harm_felt_times labelling}
dat %>%
  select(psq.interests_harm_felt_times) %>%
  str()
```



Check psq.group_injury_plotting_harm labels
"Dont know" is not coded correctly. Was originally "unsure"
```{r Check psq.group_injury_plotting_harmlabelling}
dat %>%
  select(psq.group_injury_plotting_harm) %>%
  str()
```

Rename value labels of psq.group_injury_plotting_harm
```{r Rename psq.group_injury_plotting_harm value labels}
# Named vector of correct labels
new_levels_vec <- c(
  "Don't know" = -888,
  "Seen but not answered" = -777,
  "No" = 0, 
  "Yes" = 1
    )

# Assign new labels
psq.group_injury_plotting_harm <- set_labels(dat$psq.group_injury_plotting_harm, labels = new_levels_vec)

# Remove labels vector
rm(new_levels_vec)
```

Recheck psq.group_injury_plotting_harm labelling
```{r Recheck psq.group_injury_plotting_harm labelling}
dat %>%
  select(psq.group_injury_plotting_harm) %>%
  str()
```



Check psq.past_year_strange_felt labels
"Dont know" is not coded correctly. Was originally "unsure"
```{r Check psq.past_year_strange_felt labelling}
dat %>%
  select(psq.past_year_strange_felt) %>%
  str()
```

Rename value labels of psq.past_year_strange_felt
```{r Rename psq.past_year_strange_felt value labels}
# Named vector of correct labels
new_levels_vec <- c(
  "Don't know" = -888,
  "Seen but not answered" = -777,
  "No" = 0, 
  "Yes" = 1
    )

# Assign new labels
psq.past_year_strange_felt <- set_labels(dat$psq.past_year_strange_felt, labels = new_levels_vec)

# Remove labels vector
rm(new_levels_vec)
```

Recheck psq.past_year_strange_felt labelling
```{r Recheck psq.past_year_strange_felt labelling}
dat %>%
  select(psq.past_year_strange_felt) %>%
  str()
```


Check psq.hard_strange_find_feel labels
"Dont know" is not coded correctly. Was originally "unsure"
```{r Check psq.hard_strange_find_feel labelling}
dat %>%
  select(psq.hard_strange_find_feel) %>%
  str()
```

Rename value labels of psq.hard_strange_find_feel
```{r Rename psq.hard_strange_find_feel value labels}
# Named vector of correct labels
new_levels_vec <- c(
  "Don't know" = -888,
  "Seen but not answered" = -777,
  "No" = 0, 
  "Yes" = 1
    )

# Assign new labels
psq.hard_strange_find_feel <- set_labels(dat$psq.hard_strange_find_feel, labels = new_levels_vec)

# Remove labels vector
rm(new_levels_vec)
```

Recheck psq.hard_strange_find_feel labelling
```{r Recheck psq.hard_strange_find_feel labelling}
dat %>%
  select(psq.hard_strange_find_feel) %>%
  str()
```


Check psq.heard_past_year_things labels
"Dont know" is not coded correctly. Was originally "unsure"
```{r Check psq.heard_past_year_things labelling}
dat %>%
  select(psq.heard_past_year_things) %>%
  str()
```

Rename value labels of psq.heard_past_year_things
```{r Rename psq.heard_past_year_things value labels}
# Named vector of correct labels
new_levels_vec <- c(
  "Don't know" = -888,
  "Seen but not answered" = -777,
  "No" = 0, 
  "Yes" = 1
    )

# Assign new labels
psq.heard_past_year_things <- set_labels(dat$psq.heard_past_year_things, labels = new_levels_vec)

# Remove labels vector
rm(new_levels_vec)
```

Recheck psq.heard_past_year_things labelling
```{r Recheck psq.heard_past_year_things labelling}
dat %>%
  select(psq.heard_past_year_things) %>%
  str()
```



Check psq.account_sentences_words_anytime labels
"Dont know" is not coded correctly. Was originally "unsure"
```{r Check psq.account_sentences_words_anytime labelling}
dat %>%
  select(psq.account_sentences_words_anytime) %>%
  str()
```

Rename value labels of psq.account_sentences_words_anytime
```{r Rename psq.account_sentences_words_anytime value labels}
# Named vector of correct labels
new_levels_vec <- c(
  "Don't know" = -888,
  "Seen but not answered" = -777,
  "No" = 0, 
  "Yes" = 1
    )

# Assign new labels
psq.account_sentences_words_anytime <- set_labels(dat$psq.account_sentences_words_anytime, labels = new_levels_vec)

# Remove labels vector
rm(new_levels_vec)
```

Recheck psq.account_sentences_words_anytime labelling
```{r Recheck psq.account_sentences_words_anytime labelling}
dat %>%
  select(psq.account_sentences_words_anytime) %>%
  str()


dat %>%
  freq(psq.account_sentences_words_anytime)
```

#psq.break_end_happy_felt 
#psq.was_there_an_obvious_reason_for_this
#psq.complain_strange_people 
#psq.controlled_force_person_thoughts
#psq.find_hard_instance_telepathy
#psq.felt_times_people_past 
#psq.interests_harm_felt_times
#psq.group_injury_plotting_harm
#psq.past_year_strange_felt
#psq.hard_strange_find_feel
#psq.heard_past_year_things
#psq.account_sentences_words_anytime



```{r}
label_list <- sapply(dat, function(x) c(attr(x, "label"), attr(x, "labels")))
label_list
```



# Recoding Incorrect Variables

View <incorrect variable>
<Note problem here and report on Teams>
```{r View <incorrect variable> values and labels}
attr(dat$<incorrect variable>, "labels")
```

Recode incorrect variable
Can be removed after data recoded in qualtrics and after data export
If variables are found to be incorrect:
Report the error on Teams
Recode the variable yourself using `case_when` as below
Continue cleaning your script with the recoded variable until fixed from source
DO NOT run this chunk multiple times: it will mess up the variable coding, requiring you to run the script again from the beginning
```{r Recode <incorrect variable>}
dat <- dat %>% 
  mutate(across(<incorrect variable>,
                ~case_when(
                  . == <incorrect value> ~ <correct value>,
                  TRUE ~ .)))
```

Rename value labels of <incorrect variable>
```{r Relabel <incorrect variable>}
# Named vector of correct labels
new_levels_vec <- c("<correct label>" = <value>, "<correct label>" = <value>)

# Assign new labels
dat$<incorrect variable> <- set_labels(dat$<incorrect variable>, labels = new_levels_vec)

# Remove labels vector
rm(new_levels_vec)
```

Recheck variable coding
```{r Recheck <incorrect variable> values and labels}
attr(dat$<incorrect variable>, "labels")
```


# Cleaning Textual Variables

Create vector of text variables
```{r Vector text vars}
variables_text <- c(
  "psq.information_provide_feel_free.txt"
)
```

View text variables
```{r Check text vars}
dat %>%
  select(all_of(variables_text)) %>%
  tbl_summary(missing_text = "Missing")
```

Recode <text variable>
Repeat these chunks as necessary
```{r Recode <text variable>}
dat <- dat %>% 
  mutate(across(<questionnaire.variable_name>,
                ~case_when(
                  str_detect(<questionnaire.variable_name>, "<misspelling>")  ~ "<Correct Spelling>",
                  str_detect(<questionnaire.variable_name>, "<misspelling>")  ~ "<Correct Spelling>",
                  TRUE ~ .)))
```

Re-check <text variable>
Repeat these chunks as necessary
```{r Recheck coding <text variable>}
dat %>%
  select(<questionnaire.variable_name>) %>%
  tbl_summary(missing_text = "Missing")
```

Re-check all text variables
```{r Recheck text vars coding final}
dat %>%
  select(all_of(variables_text)) %>%
  tbl_summary(missing_text = "Missing")
```



# Produce sumscores

Reference the scoring guidance that you have used for your questionnaire here <"link">

If changing na_limit, CHECK your guidance, na_limit > 0 will replace NAs with 0, ensure that this is correct for your scoring guidance before proceeding

The coding_keys vector must contain 1s for all variables to be added and -1 for all variables to be subtracted.
 - Putting 0 in the vector will omit the variable at that position.
 - length(coding_keys) MUST be the same as the number of variables to be summed

sum_vars vector should contain ONLY and ALL variable names needed for scoring, do not add "ID" or "sample" etc.

If using reverse keying:
 - MAKE SURE that reverse = TRUE is included as an argument, reverse keying will not work without this
 - reverse_vars should contain all variable names to be reverse keyed
 - If running multiple sumscores requiring reverse keying, a single reverse_vars vector containing all of the variable names to be reverse keyed is sufficient: `%in%` will pick the relevant variables for each sumscore

These warnings are normal:
 - "Scores vector contains missing values."
 - "Input contains non-answer values. These will be converted to NA_real_ for this calculation."

They are there to inform you that some sumscores have not been calculated due to non-answer values (e.g. -777) being present.
Any other errors or warnings need to be investigated.

Create required variables for sumscore arguments
```{r Sumscores inputs}
keys <- c(
  # should be a vector of 1s, 0s or -1s
  )
sum_vars <- c(
  "<questionnaire.variable_name>"
  # all variable names to add
  )
```

Generate sumscores from questionnaire data and use mutate onto dat as new column
sumscores assumes that all items in the questionnaire have the SAME minimum and maximum scores for ALL items, ensure that this is correct before proceeding

When adding the column name for your sumscore use "questionnaire.score_name"

Sumscores will produce a list of 2 elements, the first is "scores", the second is "na.count"

Add "scores" to your dataframe only, "na.count" provides a report of the number of NAs in the scoring variables for each participant

Generate sumscores
```{r Generate sumscores}
sum_out <- sumscores(input = dat,
                     sum_vars = sum_vars,
                     coding_keys = keys,
                     na_allowed = 0,
                     min_item = ,
                     max_item = ,
                     min_score = ,
                     max_score = 
                     )
```

Add sumscores as new column
```{r Add sumscores}
dat <- dat %>% 
  mutate(questionnaire.sum_score = sum_out$scores)
```


# Create phenotypes
Add explanation of phenotype here:

Create <phenotype variable>
```{r Create <pheno var>}
dat <- dat %>%
  mutate(
    <questionnaire.phenotype> =
      case_when(
        <questionnaire.sum_score> >= <threshold> ~ 1,
        <questionnaire.sum_score> < <threshold> ~ 0
      )
  )
dat %>%
  select(<questionnaire.phenotype>) %>%
  tbl_summary()
```

Label <phenotype variable>
```{r Label <pheno var>}
# Set question label
dat$<questionnaire.phenotype> <- sjlabelled::set_label(dat$<questionnaire.phenotype>, "<Phenotype Question>")

# Create vector of answer labels
<pheno_var>_labels <- c("<No Phenotype>" = 0, "<Phenotype>" = 1)

# Set answer labels
dat$<questionnaire.phenotype> <- sjlabelled::set_labels(dat$<questionnaire.phenotype>,
                                                        labels = <pheno_var>_labels)

# Remove vector of answer labels
rm(<pheno_var>_labels)

# View variable to check
sjlabelled::as_label(dat) %>%
  select(<questionnaire.phenotype>) %>%
  tbl_summary(missing_text = "Missing")
```




# Save cleaned data

# COVIDCNS
```{r Write cleaned COVIDCNS variables to a .rds file}
dat %>%
  saveRDS(
    file = paste0(ilovecovidcns, <"/data/latest_freeze/baseline/psq_covidcns_clean.rds">)
    )
```