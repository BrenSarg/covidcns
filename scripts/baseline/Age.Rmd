---
title: "Age (Covid CNS)"
author: "Abigail ter Kuile"
date: "13/01/2022"
output:
  pdf_document: default
  html_document: default
---

This R markdown:
1) Cleans the variable self-reported age at sign-up
2) Cleans date of birth (DOB) variables (age, month, year)
3) Creates DOB as a variable and calculates the variable age at sign-up from DOB
4) Cleans the variable age at sign-up calculated from DOB

# Set up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment=NA,
                      prompt=FALSE,
                      cache=FALSE)
```

## Delete everything in your global environment
```{r Delete everything in your global environment}
remove(list = ls())
```

Add the add_numeric function - used to convert character variables into numeric variables.
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
```{r Read in functions}
source(file = "../functions/add_numeric_1.R")
source(file = "../functions/remove_duplicates.R")
source(file = "../functions/sumscores.R")
source(file = "../functions/package_check.R")
source(file = "../functions/imp_check.R")
```

Note: always load tidyverse last
```{r Install load dependencies}
packages = c(
  "summarytools",
  "sjlabelled",
  "data.table",
  "Amelia",
  "lubridate",
  "tidyverse"
  )
package_check(packages)
```

## Retrieve the recent date
We are using the recent date to save files with paste0() as an extension to not overwrite old versions
```{r Recent date}
date = Sys.Date()
date
```

## Read in file with path to ilovedata channel on Teams
```{r Read in file with path to ilovedata channel on Teams}
source(file = "../credentials/paths.R")
```

# Read in the data: Demographics
## COVID CNS data

```{r  read in data}
dat <- read_rds(
  file = paste0(ilovedata, "/data_raw/latest_freeze/covid_cns/baseline/dem_covid_cns.rds")
  ) 
  
# check variable names in dataframe
dat %>%
  colnames()

# Inspect dimensions of dataframe (number of rows and columns)
dat %>%
  dim()
```


Select & rename relevant columns
```{r select & rename relevant columns}
dat_id <- dat %>% # new dataset with ID
  drop_na(externalDataReference) %>% # Drop participants with no ID
  distinct(externalDataReference, .keep_all = TRUE) %>% # Changed to distinct due to NA coercion
  add_column(sample = "COVIDCNS", 
             .after = "externalDataReference") %>% # Create new sample column
  select(
         ID = externalDataReference,# ID
         sample,
         startDate,
         endDate,
         dem.how_old_are_you_now.txt = dem.required_question_eligibility_criteria.txt, #self-reported age at sign up 
         dem.day, # day of birth
         dem.month, # month of birth
         dem.year # year of birth
         )  %>% 
   
  rename_with( ~ paste(.x, "unc", sep = "_"), starts_with("dem"))
 
# Inspect colnames
dat_id %>%
  colnames()
```
Look at number of people excluded
```{r  number excluded}
# Inspect dimensions of new data set
dat_id %>%
  dim()

# Inspect number of rows dropped
excluded <- dim(dat_id)[1]-dim(dat)[1]
excluded

```

Check missingness by missmap
```{r  inspect missingness}
 miss_map <- dat_id %>% 
   missmap()
 miss_map
```
# Clean COVID CNS age variables

## Age at sign-up (self-reported)

### Inspect age variable
```{r check values}
dat_id %>%
  freq(dem.how_old_are_you_now.txt_unc)
```

###Convert negative values of age to positive values and convert to numeric 
```{r dem.how_old_are_you_now.txt_unc conversion to positive value}
dat_id <- dat_id %>%
  mutate(
    dem.how_old_are_you_now.txt_unc =
      abs(
        as.numeric(
        dem.how_old_are_you_now.txt_unc)
      )
  )
#Check
dat_id %>%
  
  freq(dem.how_old_are_you_now.txt_unc)
```

Age outliers: 
- Lower: The data set should not have individuals younger than 16 
- Upper: The oldest person in the world is 117 years.

### Set age limits
```{r current age define limits}
age_lower_limit = 16
age_upper_limit = 117
```

### Check for number of outliers in age variable
```{r age outlier count}
dat_id %>%
  filter(
    dem.how_old_are_you_now.txt_unc > age_upper_limit | # older than the age limit
      dem.how_old_are_you_now.txt_unc < age_lower_limit # younger than the age limit
    ) %>%
  nrow()
```

### Recode age outliers to -666
```{r age Recode outliers to -666}
dat_id <- dat_id%>%
    mutate(
      dem.how_old_are_you_now.txt = # remove "_unc" from the end to show that it is now cleaned
        if_else(
          dem.how_old_are_you_now.txt_unc > age_upper_limit |
            dem.how_old_are_you_now.txt_unc < age_lower_limit,
          true = -666,
          false = dem.how_old_are_you_now.txt_unc,
          missing = NA_real_
        )
    )
```

###  Inspect clean age variable
```{r  age after recoding to -666}
dat_id %>%
  freq(dem.how_old_are_you_now.txt)
```

## Age at sign up (based on DOB)

###  Inspect DOB variables
```{r  Inspect variables}
dat_id %>% 
  freq(dem.day_unc)

dat_id %>% 
  freq(dem.month_unc)

dat_id %>% 
  freq(dem.year_unc)
```
###Convert day, month, year to numeric and negative values to positive values 
Day conversion numeric and positive values
```{r  dem.day.unc conversion to positive values and numeric}
dat_id <- dat_id %>%
  mutate(
    dem.day_unc =
      abs(
        as.numeric(
        dem.day_unc)
      )
  )
#Check
dat_id %>%
  freq(dem.day_unc)
```

Month conversion numeric and positive values
```{r  dem.month_unc conversion to positive values and numeric}
dat_id <- dat_id %>%
  mutate(
    dem.month_unc =
      abs(
        as.numeric(
        dem.month_unc)
      )
  )
#Check
dat_id %>%
  freq(dem.month_unc)
```

Year conversion numeric and positive values
```{r  dem.year_unc conversion to positive values and numeric}
dat_id <- dat_id %>%
  mutate(
    dem.year_unc =
      abs(
        as.numeric(
        dem.year_unc)
      )
  )
#Check
dat_id %>%
  freq(dem.year_unc) 
```

###  Add values to birthyear 

Birth year coding: Oldest person self-reported age is 88 (born in 1933, calculated using participant startdate) - coded values start from 14 (participant with age 88) which needs to be converted to 1933 (add 1919 years)

```{r  Add years to birthyear}
#add values to birth year
dat_id <- dat_id %>%
  mutate(dem.year_unc = dem.year_unc + 1919) ##add 1919 years

dat_id %>%
  freq(dem.year_unc)

  
```
###  Set minimum and maximum values
```{r  set minimum and maximum values dob}
# Day
day.min.scale = 1
day.max.scale = 31

# Month
month.min.scale = 1
month.max.scale = 12

# Year
year.min.scale = 1899
year.max.scale = 2021 # note max age set later in age_upper_limit
```

###  Clean dem.day
```{r  Clean dem.day}
dat_id <- dat_id %>% 
  mutate(dem.day_unc_clean =
           case_when(dem.day_unc < day.min.scale | dem.day_unc > day.max.scale ~ -666, # implausible value
                     TRUE ~ dem.day_unc)
         ) # leave as is


# Check for implausible values
dat_day_imp_n <- dat_id %>% 
  filter(dem.day_unc_clean == -666) %>% 
  nrow()

# Check
dat_day_imp_n

# If statement
if (dat_day_imp_n == 0) {
  print(paste0("The number of implausible values in the COVID CNS day of birth variable is ", dat_day_imp_n, ". This is fine."))
  setnames(dat_id,
         old = "dem.day_unc_clean",
         new = "dem.day")
} else {
  print(paste0("The number of implausible values in the COVID CNS day of birth variable is ", dat_day_imp_n, ". Please investigate."))
  setnames(dat_id,
         old = "dem.day_unc_clean",
         new = "dem.day")
}

# Check
colnames(dat_id)

# Check cleaned variable
dat_id %>% 
  freq(dem.day) 
```

###  Clean dem.month
```{r  Clean dem.month}
dat_id <- dat_id %>% 
  mutate(dem.month_unc_clean =
           case_when(dem.month_unc < month.min.scale | dem.month_unc > month.max.scale ~ -666, # implausible value
                     TRUE ~ dem.month_unc)
         ) # leave as is

# Check for implausible values
dat_month_imp_n <- dat_id %>% 
  filter(dem.month_unc_clean == -666) %>% 
  nrow()

# Check
dat_month_imp_n

# If statement
if (dat_month_imp_n == 0) {
  print(paste0("The number of implausible values in the COVID CNS month of birth variable is ", dat_month_imp_n, ". This is fine."))
  setnames(dat_id,
         old = "dem.month_unc_clean",
         new = "dem.month")
} else {
  print(paste0("The number of implausible values in the COVID CNS month of birth variable is ", dat_month_imp_n, ". Please investigate."))
  setnames(dat_id,
         old = "dem.month_unc_clean",
         new = "dem.month")
}

# Check
colnames(dat_id)

# Check clean variable
dat_id %>% 
  freq(dem.month)
```
The month variable should now be clean.

###  Clean dem.year
```{r  dem Clean dem.year}
dat_id <- dat_id %>% 
  mutate(dem.year_unc_clean =
           case_when(dem.year_unc < year.min.scale | dem.year_unc > year.max.scale ~ -666,  # implausible value
                     TRUE ~ dem.year_unc)
         )

# Check for implausible values
year_imp_n <- dat_id %>% 
  filter(dem.year_unc_clean == -666) %>% 
  nrow()

# Check
year_imp_n

# If statement
if (year_imp_n == 0) {
  print(paste0("The number of implausible values in the COVID CNS year of birth variable is ", year_imp_n, ". This is fine."))
  setnames(dat_id,
         old = "dem.year_unc_clean",
         new = "dem.year")
} else {
  print(paste0("The number of implausible values in the COVID CNS year of birth variable is ", year_imp_n, ". Please investigate."))
  setnames(dat_id,
         old = "dem.year_unc_clean",
         new = "dem.year")
}

# Check
dat_id %>% 
  freq(dem.year)


```


dat_id = clean data set, all implausible values are set to -666
However, we need to drop these values to NA in order to calculate DOB (needed for the next steps)

## Create a new data set where implausible values are dropped to NA

###  Drop all -666 to NA
```{r  Drop all -666 to NA }
dat_no_imps <- dat_id %>%
  mutate_if(is.numeric, ~na_if(., -666)) # Implausible value
```

###  Drop all variables with "_unc" on the end
```{r  Drop all variables with "_unc" on the end}
dat_clean <- dat_no_imps %>% 
  select(!contains("_unc")) # selects ID, sample and drops all uncleaned variables

# Check (there should be no variables with "_unc" in the name now)
colnames(dat_clean)
```

# Create age variable from date of birth
Use lubridate for this:
```{r  make birth date}
dat_clean <- dat_clean %>%
  mutate(dem.dob = make_date(dem.year, dem.month, dem.day))

# check
dat_clean %>% 
  select(dem.day,
         dem.month,
         dem.year,
         dem.dob) %>% 
  head()
```

###  Calculate age from birth date and startdate
note: using startdate instead of enddate and this increases N (some participants did not reach the end of the questionaire)
```{r  calculate age from birth date and startdate}
dat_clean$dem.dob_age <- interval(
    start = dat_clean$dem.dob,
    end = dat_clean$startDate) %/% # use modulo to round down by %/%
        duration(num = 1, units = "years")


# check COVID CNS age variables
dat_clean %>%
  select(dem.dob,
         dem.dob_age,
         dem.how_old_are_you_now.txt) %>% 
  head()
```
## Inspect difference self-report age and DOB age
```{r difference self-report age and DOB age}
# check COVID CNS 
diff_age_variabl_n <- dat_clean %>%
  filter(
    dem.dob_age != dem.how_old_are_you_now.txt) %>%
  select(ID, 
         dem.dob_age,
         dem.how_old_are_you_now.txt,
         dem.dob) 

diff_age_variabl_n
```
`diff_age_variabl_n` COVID CNS participants self-report a different age to their age calculated from date of birth. 


###  Convert dem.dob_age to numeric and negative values to positive values 
```{r  dem.dob_age conversion to positive values and numeric}
dat_clean <- dat_clean %>%
  mutate(
    dem.dob_age =
      abs(
        as.numeric(
        dem.dob_age)
      )
  )
#Check
dat_clean %>%
  freq(dem.dob_age)
```

###  Check for number of outliers in DOB age at sign up variable using age limits
Same age limit as used in earlier chunk for self-reported age:
age_lower_limit = 16
age_upper_limit = 117
```{r  DOB age at sign up outlier count}
dat_clean %>%
  filter(
    dem.dob_age > age_upper_limit | # older than the age limit
      dem.dob_age < age_lower_limit # younger than the age limit
    ) %>%
  nrow()
```

###  Recode DOB age at sign up at sign up outliers to -666
```{r  DOB age at sign up Recode outliers to -666}
dat_clean <- dat_clean %>%
    mutate(
      dem.dob_age = 
        if_else(
          dem.dob_age > age_upper_limit |
            dem.dob_age < age_lower_limit,
          true = -666,
          false = dem.dob_age,
          missing = NA_real_
        )
    )
```

###  Inspect clean DOB age at sign up at sign up variable
```{r  DOB age at sign up after recoding to -666}
dat_clean %>%
  freq(dem.dob_age)
```

# Save cleaned data

Check colnames before exporting final dataset
```{r check colnames}
colnames(dat_clean)
```

Save variables for exporting in clean dataset - note: DOB variables have been excluded as they contain identifiable information
```{r Save variables for export}
export_variables <- dat_clean %>% 
  select(ID,
         startDate,
         endDate,
         sample,
         dem.how_old_are_you_now.txt,
         dem.dob_age) %>%
  colnames()
```

```{r Write cleaned variables to a .rds file}
dat_clean %>% 
  select(all_of(export_variables)) %>% 
  saveRDS(
    file = paste0(ilovedata, "/data/latest_freeze/covidcns/age_covidcns_clean.rds")
    )
```

## SAVED FOR INTERNAL USE ONLY (contains dob)
```{r INTERNAL ONLY Write cleaned variables to a .rds file}
dat_clean %>% 
  saveRDS(
    file = paste0(ilovedata, "/data/latest_freeze/covidcns/age_covidcns_clean_INTERNAL_ONLY.rds")
    )
```






