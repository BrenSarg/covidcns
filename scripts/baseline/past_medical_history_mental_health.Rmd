---
title: "Past medical history (Mental Health)"
author: "Chelsea Mika Malouf"
date: "19/01/2022"
output: html_document
---

This script is to go over past medical history and consists of questions "Mental Health History".
They consist of the following question:
Have you ever been diagnosed with the following mental health disorders?


#Set up 
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = '',
  prompt = FALSE,
  cache = FALSE
)
```

```{r Delete everything in your global environment}
remove(list = ls())
```

```{r Read in functions}
source(file = "../functions/remove_duplicates.R")
source(file = "../functions/sumscores.R")
source(file = "../functions/package_check.R")
source(file = "../functions/imp_check.R")
source(file = "../functions/add_numeric.R")
```

```{r Install load dependencies}
packages <- c("summarytools",
              "sjlabelled",
              "Amelia",
              "gtsummary",
              "tidyverse")
package_check(packages)
```

```{r Recent date}
date <- Sys.Date()
date
```


```{r Read in file with path to ilovedata channel on teams}
source(file = "../../credentials/paths.R")
```


## Read in Mental Health History covid cns data
```{r Covid cns load data MHD} 
#Need to change filepath when mhd is updated to MHD
mhd_dat <- read_rds(
  file = paste0(ilovedata, "/data_raw/latest_freeze/covid_cns/baseline/mhd_covid_cns.rds")
  )
  
# Check variable names in dataframe
mhd_dat %>%
  colnames()

# Inspect dimensions of dataframe 
mhd_dat %>%
  dim()
```

```{r covid cns specify excluded columns}
exclude_cols_numeric <- c(
  "ID",
  "sample",
  "startDate",
  "endDate"
  )
```

```{r CNS select}
mhd_dat_id <- mhd_dat %>% #new dataset with ID
  drop_na(externalDataReference) %>% # Drop participants with no ID
  distinct(externalDataReference, .keep_all = TRUE) %>% # Keeps only the first line of the duplicates
  #remove_duplicates("externalDataReference") %>% # Remove duplicate IDs
  add_column(sample = "CNS",
             .after = "externalDataReference") %>% # Create new sample column
  select(
         ID = externalDataReference, # ID
         sample,
         startDate,
         endDate,
         mhd.depression,
         mhd.postnatalantenatal_depression,
         mhd.pmdd,
         mhd.mania_hypomania_bipolar_or_manicdepression,
         mhd.anxiety_nerves_or_generalised_anxiety_disorder,
         mhd.social_anxiety_or_social_phobia,
         mhd.specific_phobia,
         mhd.agoraphobia,
         mhd.panic_attacks,
         mhd.panic_disorder,
         mhd.ptsd,
         mhd.obsessivecompulsive_disorder_,
         mhd.bdd,
         mhd.other_ocd,
         mhd.none_of_the_above,
         mhd.dont_know,
         mhd.prefer_not_to_answer
         ) %>%
  add_numeric(exclude = exclude_cols_numeric)

# Inspect colnames
mhd_dat_id %>%
  colnames()
```

```{r cns number excluded}
# Inspect dimensions of new data set
mhd_dat_id %>%
  dim()

# Inspect number of rows dropped
mhd_excluded <- dim(mhd_dat_id)[1] - dim(mhd_dat)[1]
mhd_excluded
```

```{r inspect numeric variables}
mhd_dat_id %>%
   select(all_of(ends_with("numeric"))) %>%
   tbl_summary(missing_text = "Missing")
```

```{r inspect missingness}
miss_map <- mhd_dat_id %>% 
   missmap()
 
miss_map
```


Recode Non-answer values to 3 digits
-555 'Not applicable' response from participant
-777 Seen but not answered
-888 Don't know
-999 Prefer not to answer/Prefer not to say
`NA` Were not shown the question (genuinely missing value)
When we code someone as being 'not applicable' by deduction, we use `NA_real_`
```{r Recode NA values}
 dat <- mhd_dat_id %>%
   mutate(across(ends_with("numeric"),
                 ~case_when(
                   . == -55 ~ -555,
                   . == -77 ~ -777,
                   . == -88 ~ -888,
                   . == -99 ~ -999,
                   TRUE ~ .)))
```


# Cleaning Categorical variables MHD
```{r vector categorical variables mhd.depression}
variables_categorical_depression <-
  c(
    "mhd.depression"
    )
variables_categorical_depression
```

```{r vector categorical values mhd.depression}
values_categorical_depression <- 
  c(
    "Not Depression",
    "Depression",
    NA
  )
values_categorical_depression
```

```{r imp_check categorical variables mhd.depression}
imp_check(data = dat,
          variables = variables_categorical_depression,
          values = values_categorical_depression)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.postnatalantenatal_depression}
variables_categorical_postnatal_depression <-
  c(
    "mhd.postnatalantenatal_depression"
    )
variables_categorical_postnatal_depression
```

```{r vector categorical values mhd.postnatalantenatal_depression}
values_categorical_postnatal_depression <- 
  c(
    "Not Postnatal/Antenatal Depression",
    "Postnatal/Antenatal Depression",
    NA
  )
values_categorical_postnatal_depression
```

```{r imp_check categorical variables mhd.postnatalantenatal_depression}
imp_check(data = dat,
          variables = variables_categorical_postnatal_depression,
          values = values_categorical_postnatal_depression)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.pmdd}
variables_categorical_pmdd <-
  c(
    "mhd.pmdd"
    )
variables_categorical_pmdd
```

```{r vector categorical values mhd.pmdd}
values_categorical_pmdd <- 
  c(
    "Not PMDD",
    "PMDD",
    NA
  )
values_categorical_pmdd
```

```{r imp_check categorical variables mhd.pmdd}
imp_check(data = dat,
          variables = variables_categorical_pmdd,
          values = values_categorical_pmdd)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.mania_hypomania_bipolar_or_manicdepression}
variables_categorical_bipolar <-
  c(
    "mhd.mania_hypomania_bipolar_or_manicdepression"
    )
variables_categorical_bipolar
```

```{r vector categorical values mhd.mania_hypomania_bipolar_or_manicdepression}
values_categorical_bipolar <- 
  c(
    "Not Mania, hypomania, bipolar or manic-depression",
    "Mania, hypomania, bipolar or manic-depression",
    NA
  )
values_categorical_bipolar
```

```{r imp_check categorical variables mhd.mania_hypomania_bipolar_or_manicdepression}
imp_check(data = dat,
          variables = variables_categorical_bipolar,
          values = values_categorical_bipolar)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.anxiety_nerves_or_generalised_anxiety_disorder}
variables_categorical_anxiety <-
  c(
    "mhd.anxiety_nerves_or_generalised_anxiety_disorder"
    )
variables_categorical_anxiety
```

```{r vector categorical values mhd.anxiety_nerves_or_generalised_anxiety_disorder}
values_categorical_anxiety <- 
  c(
    "Not Anxiety, nerves or generalised anxiety disorder",
    "Anxiety, nerves or generalised anxiety disorder",
    NA
  )
values_categorical_anxiety
```

```{r imp_check categorical variables mhd.anxiety_nerves_or_generalised_anxiety_disorder}
imp_check(data = dat,
          variables = variables_categorical_anxiety,
          values = values_categorical_anxiety)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.social_anxiety_or_social_phobia}
variables_categorical_social_anxiety <-
  c(
    "mhd.social_anxiety_or_social_phobia"
    )
variables_categorical_social_anxiety
```

```{r vector categorical values mhd.social_anxiety_or_social_phobia}
values_categorical_social_anxiety <- 
  c(
    "Not Social anxiety or social phobia",
    "Social anxiety or social phobia",
    NA
  )
values_categorical_social_anxiety
```

```{r imp_check categorical variables mhd.social_anxiety_or_social_phobia}
imp_check(data = dat,
          variables = variables_categorical_social_anxiety,
          values = values_categorical_social_anxiety)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.specific_phobia}
variables_categorical_specific_phobia <-
  c(
    "mhd.specific_phobia"
    )
variables_categorical_specific_phobia
```

```{r vector categorical values mhd.specific_phobia}
values_categorical_specific_phobia <- 
  c(
    "Not Specific Phobia",
    "Specific Phobia",
    NA
  )
values_categorical_specific_phobia
```

```{r imp_check categorical variables mhd.specific_phobia}
imp_check(data = dat,
          variables = variables_categorical_specific_phobia,
          values = values_categorical_specific_phobia)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.agoraphobia}
variables_categorical_agoraphobia <-
  c(
    "mhd.agoraphobia"
    )
variables_categorical_agoraphobia
```

```{r vector categorical values mhd.agoraphobia}
values_categorical_agoraphobia <- 
  c(
    "Not Agoraphobia",
    "Agoraphobia",
    NA
  )
values_categorical_agoraphobia
```

```{r imp_check categorical variables mhd.agoraphobia}
imp_check(data = dat,
          variables = variables_categorical_agoraphobia,
          values = values_categorical_agoraphobia)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.panic_attacks}
variables_categorical_panic_attacks <-
  c(
    "mhd.panic_attacks"
    )
variables_categorical_panic_attacks
```

```{r vector categorical values mhd.panic_attacks}
values_categorical_panic_attacks <- 
  c(
    "Not Panic attacks",
    "Panic attacks",
    NA
  )
values_categorical_panic_attacks
```

```{r imp_check categorical variables mhd.panic_attacks}
imp_check(data = dat,
          variables = variables_categorical_panic_attacks,
          values = values_categorical_panic_attacks)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.panic_disorder}
variables_categorical_panic_disorder <-
  c(
    "mhd.panic_disorder"
    )
variables_categorical_panic_disorder
```

```{r vector categorical values mhd.panic_disorder}
values_categorical_panic_disorder <- 
  c(
    "Not Panic disorder",
    "Panic disorder",
    NA
  )
values_categorical_panic_disorder
```

```{r imp_check categorical variables mhd.panic_disorder}
imp_check(data = dat,
          variables = variables_categorical_panic_disorder,
          values = values_categorical_panic_disorder)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.ptsd}
variables_categorical_ptsd <-
  c(
    "mhd.ptsd"
    )
variables_categorical_ptsd
```

```{r vector categorical values mhd.ptsd}
values_categorical_ptsd <- 
  c(
    "Not PTSD",
    "PTSD",
    NA
  )
values_categorical_ptsd
```

```{r imp_check categorical variables mhd.ptsd}
imp_check(data = dat,
          variables = variables_categorical_ptsd,
          values = values_categorical_ptsd)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.obsessivecompulsive_disorder_}
variables_categorical_ocd <-
  c(
    "mhd.obsessivecompulsive_disorder_"
    )
variables_categorical_ocd
```

```{r vector categorical values mhd.obsessivecompulsive_disorder_}
values_categorical_ocd <- 
  c(
    "Not Obsessive-compulsive disorder (OCD)",
    "Obsessive-compulsive disorder (OCD)",
    NA
  )
values_categorical_ocd
```

```{r imp_check categorical variables mhd.obsessivecompulsive_disorder_}
imp_check(data = dat,
          variables = variables_categorical_ocd,
          values = values_categorical_ocd)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.bdd}
variables_categorical_bdd <-
  c(
    "mhd.bdd"
    )
variables_categorical_bdd
```

```{r vector categorical values mhd.bdd}
values_categorical_bdd <- 
  c(
    "Not BDD",
    "BDD",
    NA
  )
values_categorical_bdd
```

```{r imp_check categorical variables mhd.bdd}
imp_check(data = dat,
          variables = variables_categorical_bdd,
          values = values_categorical_bdd)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.other_ocd}
variables_categorical_other_ocd <-
  c(
    "mhd.other_ocd"
    )
variables_categorical_other_ocd
```

```{r vector categorical values mhd.other_ocd}
values_categorical_other_ocd <- 
  c(
    "Not Other OCD",
    "Other OCD",
    NA
  )
values_categorical_other_ocd
```

```{r imp_check categorical variables mhd.other_ocd}
imp_check(data = dat,
          variables = variables_categorical_other_ocd,
          values = values_categorical_other_ocd)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.none_of_the_above}
variables_categorical_none_mental <-
  c(
    "mhd.none_of_the_above"
    )
variables_categorical_none_mental
```

```{r vector categorical values mhd.none_of_the_above}
values_categorical_none_mental <- 
  c(
    "Not None of the above",
    "None of the above",
    NA
  )
values_categorical_none_mental
```

```{r imp_check categorical variables mhd.none_of_the_above}
imp_check(data = dat,
          variables = variables_categorical_none_mental,
          values = values_categorical_none_mental)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.dont_know}
variables_categorical_dont_know_mental <-
  c(
    "mhd.dont_know"
    )
variables_categorical_dont_know_mental
```

```{r vector categorical values mhd.dont_know}
values_categorical_dont_know_mental <- 
  c(
    "Not Don't know",
    "Don't know",
    NA
  )
values_categorical_dont_know_mental
```

```{r imp_check categorical variables mhd.dont_know}
imp_check(data = dat,
          variables = variables_categorical_dont_know_mental,
          values = values_categorical_dont_know_mental)
#There are no implausible values in the dataset. Can leave these variables as they are
```


```{r vector categorical variables mhd.prefer_not_to_answer}
variables_categorical_no_answer_mental <-
  c(
    "mhd.prefer_not_to_answer"
    )
variables_categorical_no_answer_mental
```

```{r vector categorical values mhd.prefer_not_to_answer}
values_categorical_no_answer_mental <- 
  c(
    "Not Prefer not to answer",
    "Prefer not to answer",
    NA
  )
values_categorical_no_answer_mental
```

```{r imp_check categorical variables mhd.prefer_not_to_answer}
imp_check(data = dat,
          variables = variables_categorical_no_answer_mental,
          values = values_categorical_no_answer_mental)
#There are no implausible values in the dataset. Can leave these variables as they are
```



# Numeric variables
```{r vector numeric variables 0_1 mental}
variables_numeric_0_1_mental <-
  c(
    "mhd.depression_numeric",
    "mhd.postnatalantenatal_depression_numeric",
    "mhd.pmdd_numeric",
    "mhd.mania_hypomania_bipolar_or_manicdepression_numeric",
    "mhd.anxiety_nerves_or_generalised_anxiety_disorder_numeric",
    "mhd.social_anxiety_or_social_phobia_numeric",
    "mhd.specific_phobia_numeric",
    "mhd.agoraphobia_numeric",
    "mhd.panic_attacks_numeric",
    "mhd.panic_disorder_numeric",
    "mhd.ptsd_numeric",
    "mhd.obsessivecompulsive_disorder__numeric",
    "mhd.bdd_numeric",
    "mhd.other_ocd_numeric",
    "mhd.none_of_the_above_numeric",
    "mhd.dont_know_numeric",
    "mhd.prefer_not_to_answer_numeric"
    )
variables_numeric_0_1_mental
```

```{r vector numeric values 0_1}
values_numeric_0_1_mental <- 
  c(
    -777,
    0,
    1,
    NA
  )
values_numeric_0_1_mental
```

```{r imp_check numeric variables 0_1 mental}
imp_check(data = dat,
          variables = variables_numeric_0_1_mental,
          values = values_numeric_0_1_mental)
#There are no implausible values in the dataset. Can leave these variables as they are
```


#Creating single mental health illness variable
```{r Creating mental health illness variable}
dat <- dat %>%
  mutate(
    mhd.mental_health_numeric =
      case_when(
        mhd.none_of_the_above_numeric == "1" ~ 0,
        mhd.depression_numeric == "1" ~ 1,
        mhd.postnatalantenatal_depression_numeric == "1" ~ 2,
        mhd.mania_hypomania_bipolar_or_manicdepression_numeric == "1" ~ 3,
        mhd.anxiety_nerves_or_generalised_anxiety_disorder_numeric == "1" ~ 4,
        mhd.social_anxiety_or_social_phobia_numeric == "1" ~ 5,
        mhd.specific_phobia_numeric == "1" ~ 6,
        mhd.agoraphobia_numeric == "1" ~ 7,
        mhd.panic_attacks_numeric == "1" ~ 8,
        mhd.ptsd_numeric == "1" ~ 9,
        mhd.obsessivecompulsive_disorder__numeric == "1" ~ 10,
        mhd.bdd_numeric == "1" ~ 11,
        mhd.other_ocd_numeric == "1" ~ 12,
        mhd.pmdd_numeric == "1" ~ 13,
        mhd.panic_disorder_numeric == "1" ~ 14,
        mhd.dont_know_numeric == "1" ~ -888,
        mhd.prefer_not_to_answer_numeric == "1" ~ -999,
        )
    )

#recode the numeric version into a factor
dat <- dat %>%
  mutate(
    mhd.mental_health =
      recode_factor(
        mhd.mental_health_numeric,
        `0` = "None of the above",
        `1` = "Depression",
        `2` = "Postnatal/Antenatal Depression",
        `3` = "Mania, hypomania, bipolar or manic-depression",
        `4` = "Anxiety, nerves or generalised anxiety disorder",
        `5` = "Social anxiety or social phobia",
        `6` = "Specific Phobia",
        `7` = "Agoraphobia",
        `8` = "Panic attacks",
        `9` = "PTSD",
        `10` = "Obsessive-compulsive disorder (OCD)",
        `11` = "BDD",
        `12` = "Other OCD",
        `13` = "PMDD",
        `14` = "Panic disorder",
        `-888` = "Don't know",
        `-999` = "Prefer not to answer",
        )
    )

dat %>%
  freq(mhd.mental_health_numeric)

dat %>%
  freq(mhd.mental_health)
```


# Save cleaned data
## Export variables

```{r Export variables}
export_variables <- 
  c(
         "ID",
         "sample", 
         "startDate",                                       
         "endDate", 
         "mhd.depression_numeric",
         "mhd.depression",
         "mhd.postnatalantenatal_depression_numeric",
         "mhd.postnatalantenatal_depression",
         "mhd.pmdd_numeric",
         "mhd.pmdd",
         "mhd.mania_hypomania_bipolar_or_manicdepression_numeric",
         "mhd.mania_hypomania_bipolar_or_manicdepression",
         "mhd.anxiety_nerves_or_generalised_anxiety_disorder_numeric",
         "mhd.anxiety_nerves_or_generalised_anxiety_disorder",
         "mhd.social_anxiety_or_social_phobia_numeric",
         "mhd.social_anxiety_or_social_phobia",
         "mhd.specific_phobia_numeric",
         "mhd.specific_phobia",
         "mhd.agoraphobia_numeric",
         "mhd.agoraphobia",
         "mhd.panic_attacks_numeric",
         "mhd.panic_attacks",
         "mhd.panic_disorder_numeric",
         "mhd.panic_disorder",
         "mhd.ptsd_numeric",
         "mhd.ptsd",
         "mhd.obsessivecompulsive_disorder__numeric",
         "mhd.obsessivecompulsive_disorder_",
         "mhd.bdd_numeric",
         "mhd.bdd",
         "mhd.other_ocd_numeric",
         "mhd.other_ocd",
         "mhd.none_of_the_above_numeric",
         "mhd.none_of_the_above",
         "mhd.dont_know_numeric",
         "mhd.dont_know",
         "mhd.prefer_not_to_answer_numeric",
         "mhd.prefer_not_to_answer",
         "mhd.mental_health_numeric",
         "mhd.mental_health"
         )
```

```{r Save clean data as a .rds file}
dat %>% 
  select(all_of(export_variables)) %>% 
  saveRDS(file = 
            paste0(ilovedata, "/data/latest_freeze/covidcns/past_medical_history_mental_health_covidcns_clean.rds"))
```