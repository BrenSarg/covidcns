---
title: "Cordelia Extract 2"
author: "Zain Ahmad"
date: "16/05/2022"
output: html_document
---

Data request for covid positive date for a list of IDs provided

# Set up

Configure global options for all chunks
```{r Setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = '',
  prompt = FALSE,
  cache = FALSE
  )
```

Clear global environment prior to initiation
```{r Clear global environment}
remove(list = ls())
```

Add the add_numeric function - used to convert character variables into numeric variables
Add the remove_duplicates function - used to deduplicate and remove NAs from IDs
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
Add the imp_check function - used to check variables for implausible values
```{r Read in functions}
source(file = "scripts/functions/add_numeric.R")
source(file = "scripts/functions/remove_duplicates.R")
source(file = "scripts/functions/sumscores.R")
source(file = "scripts/functions/package_check.R")
source(file = "scripts/functions/imp_check.R")
```

Use package_check to install and load dependencies
Load tidyverse last
```{r Install load dependencies}
packages <- c(
  "summarytools",
  "sjlabelled",
  "xlsx",
  "tidyverse"
  )

package_check(packages)
```

Retrieve the recent date
We are using the recent date to save files with paste0() as an extension to not overwrite old versions
```{r Recent date}
date = Sys.Date()
date
```

Read in file with path to ilovecovidcns channel on Teams
Ensure that your credentials directory is correctly located
```{r Read in file with path to ilovecovidcns channel on teams}
source(file = "scripts/credentials/paths.R")
```

### ncrf1_admission_covidcns_clean
Read in & variable names
```{r ncrf1_admission_covidcns_clean Read in data & variable names}
ncrf1_admission_covidcns_clean <-
  read_rds(
    file = 
      paste0(ilovecovidcns, "/data/latest_freeze/neuro_case_report/ncrf1_admission_covidcns_clean.rds")
  )

ncrf1_admission_covidcns_clean %>%
  dim()
```

Dimensions
```{r ncrf1_admission_covidcns_clean Dimensions}
ncrf1_admission_covidcns_clean %>%
  colnames()
```

Select columns for joining
```{r ncrf1_admission_covidcns_clean Select columns for joining}
ncrf1_admission_covidcns_clean_selected <- 
  ncrf1_admission_covidcns_clean %>%
  select(
    ID,
    startDate,
    endDate,
    ncrf1_admission.date_of_positive_covid19_test.txt
  )

ncrf1_admission_covidcns_clean_selected %>%
  slice(1:5)
```

### ncrf1_vital_covidcns_clean
Read in & variable names
```{r ncrf1_vital_covidcns_clean Read in data & variable names}
ncrf1_vital_covidcns_clean <-
  readRDS(
    file = 
      paste0(ilovecovidcns, "/data/latest_freeze/neuro_case_report/ncrf1_vital_covidcns_clean.rds")
  )

ncrf1_vital_covidcns_clean %>%
  dim()
```

Dimensions
```{r ncrf1_vital_covidcns_clean Dimensions}
ncrf1_vital_covidcns_clean %>%
  colnames()
```

Select columns for joining
```{r ncrf1_vital_covidcns_clean Select columns for joining}
ncrf1_vital_covidcns_clean_selected <- 
  ncrf1_vital_covidcns_clean %>%
  select(
    ID,
    ncrf1_vital.glasgow_coma_score.txt,
    ncrf1_vital.admission_hours_severity_covid19,
    ncrf1_vital.admission_hours_severity_covid19_numeric,
    ncrf1_vital.admission_severity_worst_covid19,
    ncrf1_vital.admission_severity_worst_covid19_numeric
  )

ncrf1_vital_covidcns_clean_selected %>%
  slice(1:5)
```

### ncrf2_vital_covidcns_clean
Read in & variable names
```{r ncrf2_vital_covidcns_clean Read in data & variable names}
ncrf2_vital_covidcns_clean <-
  read_rds(
    file = 
      paste0(ilovecovidcns, "/data/latest_freeze/neuro_case_report/ncrf2_vital_covidcns_clean.rds")
  )

ncrf2_vital_covidcns_clean %>%
  dim()
```

Dimensions
```{r ncrf2_vital_covidcns_clean Dimensions}
ncrf2_vital_covidcns_clean %>%
  colnames()
```

Select columns for joining
```{r ncrf2_vital_covidcns_clean Select columns for joining}
ncrf2_vital_covidcns_clean_selected <-
  ncrf2_vital_covidcns_clean %>%
  select(
    ID,
    ncrf2_vital.lowest_gcs_during_admission.txt
  )

ncrf2_vital_covidcns_clean_selected %>%
  slice(1:5)
```

## List of tibbles to join
```{r List of tibbles to join}
tibble_list <- 
  list(
    # ncrf1
    ncrf1_admission_covidcns_clean_selected,
    ncrf1_vital_covidcns_clean_selected,
    # ncrf2
    ncrf2_vital_covidcns_clean_selected
    )
```

Joining of demographics and questionnaires
```{r Joining of demographics and questionnaires}
data_joined <- 
  plyr::join_all(
    tibble_list,
    by = c("ID"),
    type = "full"
    )
```

Check dimensions of joined tibble
```{r Check dimensions of joined tibble}
data_joined %>%
  dim()
```

# Save joined data set
```{r cordelia Save joint dataset xlsx}
write.xlsx(x = data_joined,
           file = paste0(ilovecovidcns, "/other_data_requests/cordelia_request_2.xlsx"))
```

```{r cordelia Save joint dataset csv}
write.csv(x = data_joined,
           file = paste0(ilovecovidcns, "/other_data_requests/cordelia_request_2.csv"))
```