---
title: "COVIDCNS Neurological Impairment Survey Outpatient Cleaning Script"
author: "Zain Ahmad"
date: "22/02/2022"
output: html_document
---


All arguments should be in their own row, including the first argument
Closing bracket should have its own row
Functions with a single argument can have this on the same line
One argument can be hashed out per line for debugging errors

Chunk names should be all lower case except:
Study name (COVIDCNS) all caps
Capitalised first word

Ensure that you have deleted/untracked .DS_Store before your initial commit
Ensure that your  .gitignore contains "**/.DS_Store" before your initial commit

Configure global options for all chunks
```{r Setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = '',
  prompt = FALSE,
  cache = FALSE
  )
```

Clear global environment prior to initiation
```{r Clear global environment}
remove(list = ls())
```

Add the add_numeric function - used to convert character variables into numeric variables
Add the remove_duplicates function - used to deduplicate and remove NAs from IDs
Add the sumscores function - used to generate sumscores
Add the package_check function - used to install and load dependencies
Add the imp_check function - used to check variables for implausible values
```{r Read in functions}
source(file = "../functions/add_numeric.R")
source(file = "../functions/remove_duplicates.R")
source(file = "../functions/sumscores.R")
source(file = "../functions/package_check.R")
source(file = "../functions/imp_check_1.R")
```

Use package_check to install and load dependencies
Load tidyverse last
```{r Install load dependencies}
packages <- c("summarytools", "sjlabelled", "Amelia", "gtsummary", "tidyverse")
package_check(packages)
```

Read in file with path to ilovedata channel on Teams
Ensure that your credentials directory is correctly located
```{r Read in file with path to ilovedata channel on teams}
source(file = "../credentials/paths.R")
```

# Read in the data: Neurological Impairment Survey (Outpatient)
Change this heading to the name of your questionnaire/demographic
Load COVIDCNS data

Do not change variable names from the NLP names that are produced by the extraction
EXCEPT in exceptional circumstances
Document ANY changes to variable names in the issues spreadsheet "https://docs.google.com/spreadsheets/d/1a2gL8c0eH2pZXNTbnPzkDYQGeeVXbLKU8BUpYM0moe8/edit?usp=sharing"

- For variable names, use ONLY 'questionnaire.variable_name'
- For dataset, only use snake_case naming
- When using pipe operator '%>%', each function should begin on a new line
- Do not add empty lines at the beginning or end of a chunk
- Use only tidyverse functions wherever possible
- When naming chunks, begin with the name of the dataset (COVIDCNS)

## COVIDCNS data
```{r COVIDCNS load data}
covidcns_dat <- read_rds(
  file = paste0(ilovedata, "/data_raw/latest_freeze/covid_cns/core_neuro/nis_outp_covid_cns.rds")
  )
  
# Check variable names in dataframe
covidcns_dat %>%
  colnames()

# Inspect dimensions of dataframe 
covidcns_dat %>%
  dim()
```

Specify columns to be excluded from add_numeric function
Continuous variables should be excluded, as they are already numeric
```{r COVIDCNS specify excluded columns}
exclude_cols_numeric <- c(
  "ID",
  "sample",
  "startDate",
  "endDate",
  "nis_outp.other_observations.txt"
  )
```

Select & rename relevant columns
```{r COVIDCNS select}
covidcns_dat_id <- covidcns_dat %>% #new dataset with ID
  drop_na(externalDataReference) %>% # Drop participants with no ID
  remove_duplicates("externalDataReference") %>% # Remove duplicate IDs
  add_column(sample = "COVIDCNS",
             .after = "externalDataReference") %>% # Create new sample column
  select(
         ID = externalDataReference, # ID
         sample,
         startDate,
         endDate,
         nis_outp.left_upper_limb,
         nis_outp.right_upper_limb,
         nis_outp.left_lower_limb,
         nis_outp.right_lower_limb,
         nis_outp.trunk,
         nis_outp.motor__impairment_type,
         nis_outp.tonejoint_range,
         nis_outp.spasticity_abnormal_muscle_tightness,
         nis_outp.tendons_leading_deformity_hardening,
         nis_outp.sensation,
         nis_outp.somatic___bodily_sensation_of_touch,
         nis_outp.body_parts_awareness_position,
         nis_outp.dysesthesia__abnormal_unpleasant_sensation_felt_when_touched,
         nis_outp.perceptual_function,
         nis_outp.body_inability_body_process,
         nis_outp.process_side_external_space,
         nis_outp.speech_and_language,
         nis_outp.partial_loss_ability_expressive,
         nis_outp.comprehend_language_intact_production,
         nis_outp.unclear_articulation_speech_dysarthria,
         nis_outp.cognitive_impairment_aphasia_cognitive,
         nis_outp.cognitive_function,
         nis_outp.consciousness_cognitive_problems_related,
         nis_outp.time_place_orientation_person,
         nis_outp.memory_problems_recalling_past,
         nis_outp.attention_choose_concentrate_ability,
         nis_outp.initiate_start_initiation_action,
         nis_outp.executive_function,
         nis_outp.behaviour,
         nis_outp.threaten_offensive_language_meant,
         nis_outp.physical_aggression_behaviour_causing,
         nis_outp.social_convention_impulsivity_restraint,
         nis_outp.mood,
         nis_outp.dejection_depressionlow_mood_feelings,
         nis_outp.tension_feelings_anxiety_emotion,
         nis_outp.strong_emotions_feelings_occur,
         nis_outp.seeing_and_vision,
         nis_outp.visual_field_area_lost,
         nis_outp.corrected_lost_vision_spectacles,
         nis_outp.images_overlapping_double_vision,
         nis_outp.not_applicable,
         nis_outp.hearing,
         nis_outp.damage_ear_auditory_nerve,
         nis_outp.outer_sounds_conductive_hearing,
         nis_outp.not_applicable.1,
         nis_outp.pain,
         nis_outp.burning_electrical_disease_lesion,
         nis_outp.muscles_ligaments_tendons_constant,
         nis_outp.spasticity_pain_occurring_spasticity,
         nis_outp.fatigue,
         nis_outp.perform_physical_exercise_physical,
         nis_outp.muscle_fatigability_decline_muscles,
         nis_outp.cognitive_fatigue_extreme_capable,
         nis_outp.other,
         nis_outp.loss_consciousness_andor_rhythmic,
         nis_outp.skin_pressure_sores_injuries,
         nis_outp.other_observations.txt
         ) %>%
  add_numeric(exclude = exclude_cols_numeric)

# Inspect colnames
covidcns_dat_id %>%
  colnames()
```

Look at number of people excluded
The number of people to be excluded should be negative
```{r COVIDCNS number excluded}
# Inspect dimensions of new data set
covidcns_dat_id %>%
  dim()

# Inspect number of rows dropped
covidcns_excluded <- dim(covidcns_dat_id)[1] - dim(covidcns_dat)[1]
covidcns_excluded
```

Check missingness by missmap
```{r COVIDCNS inspect missingness}
covidcns_miss_map <- covidcns_dat_id %>% 
  missmap()

covidcns_miss_map
```

Create dat as copy of covidcns_dat_id for brevity
This step gives you a 'reset' point: if your variable recoding screws up, re-run this chunk to give you a fresh 'dat' dataframe
```{r Create dat}
dat <- covidcns_dat_id 

# Check
dat %>% glimpse()
```

Recode Non-answer values to 3 digits
-555 'Not applicable' response from participant
-777 Seen but not answered
-888 Don't know
-999 Prefer not to answer/Prefer not to say
`NA` Were not shown the question (genuinely missing value)
When we code someone as being 'not applicable' by deduction, we use `NA_real_`
```{r Recode NA values}
dat <- dat %>%
  mutate(across(ends_with("numeric"),
                ~case_when(
                  . == -55 ~ -555,
                  . == -77 ~ -777,
                  . == -88 ~ -888,
                  . == -99 ~ -999,
                  TRUE ~ .)))
```

Create list of all unique values and levels
Use the unique list as a reference for numeric variables
Use the levels list as a reference for categorical variables
```{r List unique values}
ulst <- sapply(dat, unique)
llst <- sapply(dat, levels)
```




# Cleaning Categorical Variables

Name your vectors in line with the chunks below
Number the vectors or name them intuitively if you have multiple vectors
Vectors of potential values should only contain possible values (exclude nonanswer values as appropriate)


## Cleaning Domains

Create sequential vectors of categorical values for variables
```{r Vectors categorical domains values}
values_cat_domains_1 <- c( # same for first 5 variables
  "0 (None - No weakness/loss of motor control/coordination)",
  "1 (Mild - Affecting higher level motor control only)",
  "2 (Moderate - Significant impact on function but some useful active movement)",
  "3 (Severe - Severe loss of motor control, with little or no active movement)",
  "Seen but not answered",
  NA
)

values_cat_domains_2 <- c( # second 'mild' is not capitalised in level '1'
  "0 (None - No spasticity/contractures)",
  "1 (Mild - Mild tone problems - can achieve full range of movement)",
  "2 (Moderate - Significant spasticity with mild restriction of some joint range: 1-2 joints only)",
  "3 (Severe - Severe spasticity/contracture with marked restriction of joint range - limiting function)",
  "Seen but not answered",
  NA
)

values_cat_domains_3 <- c(
  "0 (None - No dysaethesia, loss of sensation or joint position sense)",
  "1 (Mild - Mild or patchy loss - minimal interference with sensory function)",
  "2 (Moderate - Partial sensory loss with significant impact on ability to feel the limb and where it is)",
  "3 (Severe - Complete/near-complete loss of sensation - all modalities - in one or more limbs)",
  "Seen but not answered",
  NA
)

values_cat_domains_4 <- c(
  "0 (None - No neglect of body or external space: i.e. does not ignore body parts or bump into things)",
  "1 (Mild - Mild neglect, but compensates effectively - minimal interference with function)",
  "2 (Moderate - Bumps into things or ignores body parts some of the time with significant impact on function)",
  "3 (Severe - Total neglect of body part or field effectively limiting independence/rehabilitation)",
  "Seen but not answered",
  NA
)

values_cat_domains_5 <- c(
  "0 (None - No deficit in expression / comprehension or articulation of language)",
  "1 (Mild - Mild deficit affecting high level communication only)",
  "2 (Moderate - Moderate deficit with significant impact on functional communication/listener burden)",
  "3 (Severe - Severe deficit - communication through language effectively not possible)",
  "Seen but not answered",
  NA
)

values_cat_domains_6 <- c(
  "0 (None - No cognitive deficit)",
  "1 (Mild - Mild deficit affecting higher level cognitive function only)",
  "2 (Moderate - Moderate deficit with significant impact on carryover and engagement in rehabilitation)",
  "3 (Severe - Severe cognitive effectively limiting carryover and engagement in rehabilitation)",
  "Seen but not answered",
  NA
)

values_cat_domains_7 <- c(
  "0 (None - No problems with aggression or disinhibtion)",
  "1 (Mild - Occasional mild outbursts/disinhibition, with minimal impact on function / rehabilitation)",
  "2 (Moderate - Moderate behavioural problems with significant impact / interference with rehab)",
  "3 (Severe - Severe behaviours / hitting / biting / scratching / etc. which effectively limit rehab)",
  "Seen but not answered",
  NA
)

values_cat_domains_8 <- c(
  "0 (None - No mood disturbance: depressive or anxiety)",
  "1 (Mild - Mild mood problems not interfering with daily function)",
  "2 (Moderate - Significant mood disturbance with some impact on function / engagement in rehab)",
  "3 (Severe - Severe mood disorder effectively limiting engagement in rehab)",
  "Seen but not answered",
  NA
)

values_cat_domains_9 <- c(
  "0 (None - No visual deficit)",
  "1 (Mild - Mild visual deficit correctable with compensatory techniques)",
  "2 (Moderate - Moderate visual disturbance with significant limitation on function: partially sighted)",
  "3 (Severe - Effectively blind: little or no useful vision)",
  "Seen but not answered",
  NA
)

values_cat_domains_10 <- c(
  "0 (None - No hearing deficit)",
  "1 (Mild - Mild hearing deficit correctable with hearing aid)",
  "2 (Moderate - Moderate hearing disturbance with significant limitation on function: partially deaf)",
  "3 (Severe - Effectively deaf: little or no useful hearing)",
  "Seen but not answered",
  NA
)

values_cat_domains_11 <- c(
  "0 (None - No pain)",
  "1 (Mild - Mild pain, easily controlled with little impact on function / rehab)",
  "2 (Moderate - Moderate pain, incompletely controlled with significant impact on function / rehab)",
  "3 (Severe - Severe pain: effectively limits function / engagement in rehabilitation)",
  "Seen but not answered",
  NA
)

values_cat_domains_12 <- c(
  "0 (None - No fatigue)",
  "1 (Mild - Mild fatigue, easily controlled through pacing with little impact on function / rehab)",
  "2 (Moderate - Moderate fatigue, incompletely controlled - significant interference with function / rehab)",
  "3 (Severe - Effectively limits function / engagement in rehabilitation)",
  "Seen but not answered",
  NA
)

values_cat_domains_13 <- c(
  "0 (None - No seizures / sores)",
  "1 (Minimal - Minimal / occasional: little interference with function / rehab)",
  "2 (Marked - Interference with function / rehabilitation)",
  "Unknown",
  "Seen but not answered",
  NA
)
```

Create list of categorical domains values vectors
```{r List categorical domains values vectors}
values_cat_domains_list <- list(
  values_cat_domains_1,
  values_cat_domains_1,
  values_cat_domains_1,
  values_cat_domains_1,
  values_cat_domains_1,
  values_cat_domains_2,
  values_cat_domains_3,
  values_cat_domains_4,
  values_cat_domains_5,
  values_cat_domains_6,
  values_cat_domains_7,
  values_cat_domains_8,
  values_cat_domains_9,
  values_cat_domains_10,
  values_cat_domains_11,
  values_cat_domains_12,
  values_cat_domains_13
)
```

Create vector of categorical domains variables 
```{r Vector categorical domains variables}
variables_cat_domains <- c(
  "nis_outp.left_upper_limb", #1
  "nis_outp.right_upper_limb", #1
  "nis_outp.left_lower_limb", #1
  "nis_outp.right_lower_limb", #1
  "nis_outp.trunk", #1
  "nis_outp.tonejoint_range", #2
  "nis_outp.sensation", #3
  "nis_outp.perceptual_function",#4
  "nis_outp.speech_and_language", #5
  "nis_outp.cognitive_function", #6
  "nis_outp.behaviour", #7
  "nis_outp.mood", #8
  "nis_outp.seeing_and_vision", #9
  "nis_outp.hearing", #10
  "nis_outp.pain", #11
  "nis_outp.fatigue", #12
  "nis_outp.other" #13
)
```

Set names of list to variable names
```{r Set list names}
names(values_cat_domains_list) <- variables_cat_domains
```


Use imp_check iteratively to find if any implausible values and obtain summary table of variables
```{r Imp_check categorical domains variables}
# Create empty list
imp_list_cat_domains <- list()

# Loop over each variable, checking against relevant set of values from list
# Add imp_message to list
for (i in 1:length(variables_cat_domains)) {
  imp_list_cat_domains[i] <- imp_check_1(data = dat,
                                     variables = names(values_cat_domains_list)[i],
                                     values = values_cat_domains_list[[i]]) 

}

# Name list with var names to correspond to imp_messages
names(imp_list_cat_domains) <- variables_cat_domains

# View list of imp_messages with corresponding var names
print(imp_list_cat_domains)
```

Produce summary table of variables
```{r Summary table categorical domains variables}
dat %>%
  tbl_summary(
    include = all_of(variables_cat_domains),
    missing_text = "Missing")
```


## Cleaning Impairments

Create sequential vectors of categorical values for variables
```{r Vectors categorical impairments values}
values_cat_impairms_1 <- c(
  "R Hemiparesis - weakness to the right side of the body (arm and leg)",
  "L Hemiparesis - weakness to the left side of the body (arm and leg)",
  "Tetraparesis - weakness to all limbs (both arms and both legs)",
  "Paraparesis - weakness to either both arms or both legs",
  "Monoparesis - weakness of one limb (one arm or leg)",
  "Ataxia - loss of control of movement / uncoordinated movements",
  "Seen but not answered",
  NA
)

values_cat_impairms_2 <- c(
  "Not Spasticity - abnormal muscle tightness and weakness (but it is still possible to move the muscle passively",
  "Spasticity - abnormal muscle tightness and weakness (but it is still possible to move the muscle passively",
  NA
)

values_cat_impairms_3 <- c(
  "Not Contractures - shortening and hardening of the muscle and tendons leading to a deformity and reduced range of movements (the muscle is fixed in place)",
  "Contractures - shortening and hardening of the muscle and tendons leading to a deformity and reduced range of movements (the muscle is fixed in place)",
  NA
)

values_cat_impairms_4 <- c(
  "Not Somatic (e.g. touch) - bodily sensation of touch",
  "Somatic (e.g. touch) - bodily sensation of touch",
  NA
)

values_cat_impairms_5 <- c(
  "Not Proprioception - perception or awareness of the position and movement of body parts",
  "Proprioception - perception or awareness of the position and movement of body parts",
  NA
)

values_cat_impairms_6 <- c(
  "Not Dysesthesia - abnormal unpleasant sensation felt when touched",
  "Dysesthesia - abnormal unpleasant sensation felt when touched",
  NA
)

values_cat_impairms_7 <- c(
  "Not Neglect of body - inability to process and perceive stimuli on one side of the body",
  "Neglect of body - inability to process and perceive stimuli on one side of the body",
  NA
)

values_cat_impairms_8 <- c(
  "Not Neglect of external space - inability to process and perceive stimuli on one side of the room / space",
  "Neglect of external space - inability to process and perceive stimuli on one side of the room / space",
  NA
)

values_cat_impairms_9 <- c(
  "Not Expressive - complete or partial loss of the ability to produce language (spoken, manual, or written) with intact comprehension",
  "Expressive - complete or partial loss of the ability to produce language (spoken, manual, or written) with intact comprehension",
  NA
)

values_cat_impairms_10 <- c(
  "Not Receptive - complete or partial loss of the ability to comprehend language (spoken, manual, or written) with intact production of language",
  "Receptive - complete or partial loss of the ability to comprehend language (spoken, manual, or written) with intact production of language",
  NA
)

values_cat_impairms_11 <- c(
  "Not Dysarthria - difficult or unclear articulation of speech that is otherwise linguistically normal",
  "Dysarthria - difficult or unclear articulation of speech that is otherwise linguistically normal",
  NA
)

values_cat_impairms_12 <- c(
  "Not Cognitive speech - speech problems related to cognitive impairment more than to aphasia",
  "Cognitive speech - speech problems related to cognitive impairment more than to aphasia",
  NA
)

values_cat_impairms_13 <- c(
  "Not Consciousness - cognitive problems related to reduced consciousness (e.g. when drowsy, sleepy)",
  "Consciousness - cognitive problems related to reduced consciousness (e.g. when drowsy, sleepy)",
  NA
)

values_cat_impairms_14 <- c(
  "Not Orientation - problems related to orientation in time, place and person",
  "Orientation - problems related to orientation in time, place and person",
  NA
)
     
values_cat_impairms_15 <- c(
  "Not Memory - Problems recalling past events (either short or long term)",
  "Memory - Problems recalling past events (either short or long term)",
  NA
)

values_cat_impairms_16 <- c(
  "Not Attention - the ability to choose and concentrate on relevant stimuli",
  "Attention - the ability to choose and concentrate on relevant stimuli",
  NA
)

values_cat_impairms_17 <- c(
  "Not Initiation - the ability to initiate / start a certain action (when abnormal a person might e.g. not respond or respond with a delay)",
  "Initiation - the ability to initiate / start a certain action (when abnormal a person might e.g. not respond or respond with a delay)",
  NA
)

values_cat_impairms_18 <- c(
  "Not Executive function (e.g. insight, planning, flexible thought) - a set of mental skills that include working memory, flexible thinking, and self-control (when abnormal a person might be unable to plan an action)",
  "Executive function (e.g. insight, planning, flexible thought) - a set of mental skills that include working memory, flexible thinking, and self-control (when abnormal a person might be unable to plan an action)",
  NA
)
 
values_cat_impairms_19 <- c(
  "Not Verbal aggression - the use of offensive language meant to threaten someone",
  "Verbal aggression - the use of offensive language meant to threaten someone",
  NA
)

values_cat_impairms_20 <- c(
  "Not Physical aggression - behaviour causing or threatening physical harm towards others",
  "Physical aggression - behaviour causing or threatening physical harm towards others",
  NA
)

values_cat_impairms_21 <- c(
  "Not Disinhibition - lack of restraint manifested in disregard of social convention, impulsivity, and poor risk assessment",
  "Disinhibition - lack of restraint manifested in disregard of social convention, impulsivity, and poor risk assessment",
  NA
)

values_cat_impairms_22 <- c(
  "Not Depression/Low mood - feelings of severe despondency and dejection",
  "Depression/Low mood - feelings of severe despondency and dejection",
  NA
)

values_cat_impairms_23 <- c(
  "Not Anxiety - emotion characterised by feelings of tension and worries thoughts",
  "Anxiety - emotion characterised by feelings of tension and worries thoughts",
  NA
)

values_cat_impairms_24 <- c(
  "Not Emotional liability - rapid, often exaggerated changes in mood, where strong emotions or feelings occur",
  "Emotional liability - rapid, often exaggerated changes in mood, where strong emotions or feelings occur",
  NA
)

values_cat_impairms_25 <- c(
  "Not Visual field loss/inattention - an area of the visual field is lost",
  "Visual field loss/inattention - an area of the visual field is lost",
  NA
)

values_cat_impairms_26 <- c(
  "Not Uncorrectable acuity - sharpness of vision is lost and cannot be corrected by e.g. spectacles",
  "Uncorrectable acuity - sharpness of vision is lost and cannot be corrected by e.g. spectacles",
  NA
)

values_cat_impairms_27 <- c(
  "Not Double vision - simultaneous perception of two images, usually overlapping, of a single scene or object",
  "Double vision - simultaneous perception of two images, usually overlapping, of a single scene or object",
  NA
)

values_cat_impairms_28 <- c(
  "Not Not applicable",
  "Not applicable",
  NA
)

values_cat_impairms_29 <- c(
  "Not Sensorineural - hearing loss occurring from damage to the inner ear, the auditory nerve, or the brain",
  "Sensorineural - hearing loss occurring from damage to the inner ear, the auditory nerve, or the brain",
  NA
)

values_cat_impairms_30 <- c(
  "Not Conductive - hearing loss occurring when sounds cannot get through the outer and middle ear (e.g. the ear canal is blocked)",
  "Conductive - hearing loss occurring when sounds cannot get through the outer and middle ear (e.g. the ear canal is blocked)",
  NA
)

values_cat_impairms_31 <- c(
  "Not Not applicable",
  "Not applicable",
  NA
)

values_cat_impairms_32 <- c(
  "Not Neuropathic pain - pain caused by a lesion or disease of the somatosensory nervous system, often described as burning, electrical, or shooting pain",
  "Neuropathic pain - pain caused by a lesion or disease of the somatosensory nervous system, often described as burning, electrical, or shooting pain",
  NA
)

values_cat_impairms_33 <- c(
  "Not Musculoskeletal pain - pain affecting the muscles. ligaments, tendons, and bones, often described as constant, pulling or 'muscle ache'",
  "Musculoskeletal pain - pain affecting the muscles. ligaments, tendons, and bones, often described as constant, pulling or 'muscle ache'",
  NA
)

values_cat_impairms_34 <- c(
  "Not Pain due to spasticity - pain occurring as part of spasticity",
  "Pain due to spasticity - pain occurring as part of spasticity",
  NA
)

values_cat_impairms_35 <- c(
  "Not Reduced cardiovascular fitness - inability to perform physical exercise or physical work",
  "Reduced cardiovascular fitness - inability to perform physical exercise or physical work",
  NA
)

values_cat_impairms_36 <- c(
  "Not Muscle fatigability - the decline in ability of muscles to generate force or sustain activity",
  "Muscle fatigability - the decline in ability of muscles to generate force or sustain activity",
  NA
)

values_cat_impairms_37 <- c(
  "Not Cognitive fatigue (ICF??) - extreme and persistent sense of tiredness, but when required a person is capable of performing physical exercise or work",
  "Cognitive fatigue (ICF??) - extreme and persistent sense of tiredness, but when required a person is capable of performing physical exercise or work",
  NA
)

values_cat_impairms_38 <- c(
  "Not Seizures (ICF ??) - sudden attacks of loss of consciousness and/or rhythmic motor activity that cannot be voluntarily controlled",
  "Seizures (ICF ??) - sudden attacks of loss of consciousness and/or rhythmic motor activity that cannot be voluntarily controlled",
  NA
)

values_cat_impairms_39 <- c(
  "Not Pressure sores - injuries to the skin and underlying tissue, primarily caused by prolonged pressure on the skin",
  "Pressure sores - injuries to the skin and underlying tissue, primarily caused by prolonged pressure on the skin",
  NA
)

```

Create list of categorical impairments values vectors
```{r List categorical impairments values vectors}
values_cat_impairms_list <- list(
  values_cat_impairms_1,
  values_cat_impairms_2,
  values_cat_impairms_3,
  values_cat_impairms_4,
  values_cat_impairms_5,
  values_cat_impairms_6,
  values_cat_impairms_7,
  values_cat_impairms_8,
  values_cat_impairms_9,
  values_cat_impairms_10,
  values_cat_impairms_11,
  values_cat_impairms_12,
  values_cat_impairms_13,
  values_cat_impairms_14,
  values_cat_impairms_15,
  values_cat_impairms_16,
  values_cat_impairms_17,
  values_cat_impairms_18,
  values_cat_impairms_19,
  values_cat_impairms_20,
  values_cat_impairms_21,
  values_cat_impairms_22,
  values_cat_impairms_23,
  values_cat_impairms_24,
  values_cat_impairms_25,
  values_cat_impairms_26,
  values_cat_impairms_27,
  values_cat_impairms_28,
  values_cat_impairms_29,
  values_cat_impairms_30,
  values_cat_impairms_31,
  values_cat_impairms_32,
  values_cat_impairms_33,
  values_cat_impairms_34,
  values_cat_impairms_35,
  values_cat_impairms_36,
  values_cat_impairms_37,
  values_cat_impairms_38,
  values_cat_impairms_39
)
```

Create vector of categorical domains variables 
```{r Vector categorical impairments variables}
variables_cat_impairms <- c(
  "nis_outp.motor__impairment_type",
  "nis_outp.spasticity_abnormal_muscle_tightness",
  "nis_outp.tendons_leading_deformity_hardening",
  "nis_outp.somatic___bodily_sensation_of_touch",
  "nis_outp.body_parts_awareness_position",
  "nis_outp.dysesthesia__abnormal_unpleasant_sensation_felt_when_touched",
  "nis_outp.body_inability_body_process",
  "nis_outp.process_side_external_space",
  "nis_outp.partial_loss_ability_expressive",
  "nis_outp.comprehend_language_intact_production",
  "nis_outp.unclear_articulation_speech_dysarthria",
  "nis_outp.cognitive_impairment_aphasia_cognitive",
  "nis_outp.consciousness_cognitive_problems_related",
  "nis_outp.time_place_orientation_person",
  "nis_outp.memory_problems_recalling_past",
  "nis_outp.attention_choose_concentrate_ability",
  "nis_outp.initiate_start_initiation_action",
  "nis_outp.executive_function",
  "nis_outp.threaten_offensive_language_meant",
  "nis_outp.physical_aggression_behaviour_causing",
  "nis_outp.social_convention_impulsivity_restraint",
  "nis_outp.dejection_depressionlow_mood_feelings",
  "nis_outp.tension_feelings_anxiety_emotion",
  "nis_outp.strong_emotions_feelings_occur",
  "nis_outp.visual_field_area_lost",
  "nis_outp.corrected_lost_vision_spectacles",
  "nis_outp.images_overlapping_double_vision",
  "nis_outp.not_applicable",
  "nis_outp.damage_ear_auditory_nerve",
  "nis_outp.outer_sounds_conductive_hearing",
  "nis_outp.not_applicable.1",
  "nis_outp.burning_electrical_disease_lesion",
  "nis_outp.muscles_ligaments_tendons_constant",
  "nis_outp.spasticity_pain_occurring_spasticity",
  "nis_outp.perform_physical_exercise_physical",
  "nis_outp.muscle_fatigability_decline_muscles",
  "nis_outp.cognitive_fatigue_extreme_capable",
  "nis_outp.loss_consciousness_andor_rhythmic",
  "nis_outp.skin_pressure_sores_injuries"
)
```

Set names of list to variable names
```{r Set list names}
names(values_cat_impairms_list) <- variables_cat_impairms
```


Use imp_check iteratively to find if any implausible values and obtain summary table of variables
```{r Imp_check categorical impairments variables}
# Create empty list
imp_list_cat_impairms <- list()

# Loop over each variable, checking against relevant set of values from list
# Add imp_message to list
for (i in 1:length(variables_cat_impairms)) {
  imp_list_cat_impairms[i] <- imp_check_1(data = dat,
                                     variables = names(values_cat_impairms_list)[i],
                                     values = values_cat_impairms_list[[i]]) 

}

# Name list with var names to correspond to imp_messages
names(imp_list_cat_impairms) <- variables_cat_impairms

# View list of imp_messages with corresponding var names
print(imp_list_cat_impairms)
```

Produce summary table of variables
```{r Summary table categorical impairments variables}
dat %>%
  tbl_summary(
    include = all_of(variables_cat_impairms),
    missing_text = "Missing")
```




# Cleaning Numeric Variables

Name your vectors in line with the chunks below
Number the vectors or name them intuitively if you have multiple vectors
Vectors of potential values should only contain possible values (exclude nonanswer values as appropriate)


## Cleaning Domains

Create vector of numeric values for domains
```{r Vector numeric domain values}
values_num_domains <- c(
  0,
  1,
  2,
  3,
  -777,
  NA
)
```

Create vector of numeric variables for domains
```{r Vector numeric domain variables}
variables_num_domains <- c(
  "nis_outp.left_upper_limb_numeric",
  "nis_outp.right_upper_limb_numeric",
  "nis_outp.left_lower_limb_numeric",
  "nis_outp.right_lower_limb_numeric",
  "nis_outp.trunk_numeric",
  "nis_outp.tonejoint_range_numeric",
  "nis_outp.sensation_numeric",
  "nis_outp.perceptual_function_numeric",
  "nis_outp.speech_and_language_numeric",
  "nis_outp.cognitive_function_numeric",
  "nis_outp.behaviour_numeric",
  "nis_outp.mood_numeric",
  "nis_outp.seeing_and_vision_numeric",
  "nis_outp.hearing_numeric",
  "nis_outp.pain_numeric",
  "nis_outp.fatigue_numeric"
)
```

Use imp_check iteratively to find if any implausible values
```{r Imp_check numeric domain variables}
# Create empty list
imp_list_num_domains <- list()

# Loop over each variable
# Check if any implausible values as listed in values vector
# Add imp_message to list
for (i in 1:length(variables_num_domains)) {
  imp_list_num_domains[i] <- imp_check_1(data = dat,
                                     variables = variables_num_domains[i],
                                     values = values_num_domains) 

}

# Set names of list of imp_messages to var names
names(imp_list_num_domains) <- variables_num_domains

# View named list of imp_messages
print(imp_list_num_domains)
```

Produce summary table of variables
```{r Summary table numeric domain variables}
dat %>%
  tbl_summary(
    include = all_of(variables_num_domains),
    missing_text = "Missing")
```



## Cleaning Impairments

Create vector of numeric values for impairments
```{r Vector numeric impairments values}
values_num_impairms <- c(
  0,
  1,
  -777,
  NA
)
```

Create vector of numeric variables for impairments
```{r Vector numeric impairments variables}
variables_num_impairms <- c(
  "nis_outp.spasticity_abnormal_muscle_tightness_numeric",
  "nis_outp.tendons_leading_deformity_hardening_numeric",
  "nis_outp.somatic___bodily_sensation_of_touch_numeric",
  "nis_outp.body_parts_awareness_position_numeric",
  "nis_outp.dysesthesia__abnormal_unpleasant_sensation_felt_when_touched_numeric",
  "nis_outp.body_inability_body_process_numeric",
  "nis_outp.process_side_external_space_numeric",
  "nis_outp.partial_loss_ability_expressive_numeric",
  "nis_outp.comprehend_language_intact_production_numeric",
  "nis_outp.unclear_articulation_speech_dysarthria_numeric",
  "nis_outp.cognitive_impairment_aphasia_cognitive_numeric",
  "nis_outp.consciousness_cognitive_problems_related_numeric",
  "nis_outp.time_place_orientation_person_numeric",
  "nis_outp.memory_problems_recalling_past_numeric",
  "nis_outp.attention_choose_concentrate_ability_numeric",
  "nis_outp.initiate_start_initiation_action_numeric",
  "nis_outp.executive_function_numeric",
  "nis_outp.threaten_offensive_language_meant_numeric",
  "nis_outp.physical_aggression_behaviour_causing_numeric",
  "nis_outp.social_convention_impulsivity_restraint_numeric",
  "nis_outp.dejection_depressionlow_mood_feelings_numeric",
  "nis_outp.tension_feelings_anxiety_emotion_numeric",
  "nis_outp.strong_emotions_feelings_occur_numeric",
  "nis_outp.visual_field_area_lost_numeric",
  "nis_outp.corrected_lost_vision_spectacles_numeric",
  "nis_outp.images_overlapping_double_vision_numeric",
  "nis_outp.not_applicable_numeric",
  "nis_outp.damage_ear_auditory_nerve_numeric",
  "nis_outp.outer_sounds_conductive_hearing_numeric",
  "nis_outp.not_applicable.1_numeric",
  "nis_outp.burning_electrical_disease_lesion_numeric",
  "nis_outp.muscles_ligaments_tendons_constant_numeric",
  "nis_outp.spasticity_pain_occurring_spasticity_numeric",
  "nis_outp.perform_physical_exercise_physical_numeric",
  "nis_outp.muscle_fatigability_decline_muscles_numeric",
  "nis_outp.cognitive_fatigue_extreme_capable_numeric",
  "nis_outp.loss_consciousness_andor_rhythmic_numeric",
  "nis_outp.skin_pressure_sores_injuries_numeric"
)
```

Use imp_check iteratively to find if any implausible values
```{r Imp_check numeric impairments variables}
# Create empty list
imp_list_num_impairms <- list()

# Loop over each variable
# Check if any implausible values as listed in values vector
# Add imp_message to list
for (i in 1:length(variables_num_impairms)) {
  imp_list_num_impairms[i] <- imp_check_1(data = dat,
                                     variables = variables_num_impairms[i],
                                     values = values_num_impairms) 

}

# Set names of list of imp_messages to var names
names(imp_list_num_impairms) <- variables_num_impairms

# View named list of imp_messages
print(imp_list_num_impairms)
```

Produce summary table of variables
```{r Summary table numeric impairments variables}
dat %>%
  tbl_summary(
    include = all_of(variables_num_impairms),
    missing_text = "Missing")
```

## Cleaning Numerics Continued

2 numeric variables need to be cleaned separately as they have different scales:

"nis_outp.motor__impairment_type_numeric",
"nis_outp.other_numeric"



Create sequential vectors of numeric values for variables
```{r Vectors numeric values}
values_num_1 <- c(
  1,
  2,
  3,
  4,
  5,
  6,
  -777,
  NA
)

values_num_2 <- c(
  0,
  1,
  -777,
  -888,
  NA
)
```

Create list of numeric values vectors
```{r List numeric values vectors}
values_num_list <- list(
  values_num_1,
  values_num_2
)
```

Create vector of categorical domains variables 
```{r Vector numeric variables}
variables_num <- c(
  "nis_outp.motor__impairment_type_numeric",
  "nis_outp.other_numeric"
)
```

Set names of list to variable names
```{r Set list names}
names(values_num_list) <- variables_num
```


Use imp_check iteratively to find if any implausible values
```{r Imp_check numeric variables}
# Create empty list
imp_list_num <- list()

# Loop over each variable, checking against relevant set of values from list
# Add imp_message to list
for (i in 1:length(variables_num)) {
  imp_list_num[i] <- imp_check_1(data = dat,
                                 variables = names(values_num_list)[i],
                                 values = values_num_list[[i]]) 

}

# Name list with var names to correspond to imp_messages
names(imp_list_num) <- variables_num

# View list of imp_messages with corresponding var names
print(imp_list_num)
```


# Produce sumscores
Reference the scoring guidance that you have used for your questionnaire here "link"

If changing na_limit, CHECK your guidance, na_limit > 0 will replace NAs with 0, ensure that this is correct for your scoring guidance before proceeding

Create vector of item coding
The coding_keys vector must contain 1s for all variables to be added and -1 for all variables to be subtracted.
Putting 0 in the vector will omit the variable at that position.
length(coding_keys) MUST be the same as the number of variables to be summed

sum_vars vector should contain ONLY and ALL variable names needed for scoring, do not add "ID" or "sample" etc.

If using reverse keying:
MAKE SURE that Reverse = TRUE is included as an argument, reverse keying will not work without this
reverse_vars should contain all variable names to be reverse keyed
If running multiple sumscores requiring reverse keying, a single reverse_vars vector containing all of the variable names to be reverse keyed is sufficient: `%in%` will pick the relevant variables for each sumscore

The warnings "Scores vector contains missing values." and "Input contains non-answer values. These will be converted to NA_real_ for this calculation." are normal. They are there to inform you that some sumscores have not been calculated due to non-answer values (e.g. -777) being present. Any other errors or warnings need to be investigated.

Create required variables for sumscore arguments
```{r Sumscores inputs}
keys <- c(
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1,
  1
  )

sum_vars <- c(
  "nis_outp.left_upper_limb_numeric",
  "nis_outp.right_upper_limb_numeric",
  "nis_outp.left_lower_limb_numeric",
  "nis_outp.right_lower_limb_numeric",
  "nis_outp.trunk_numeric",
  "nis_outp.tonejoint_range_numeric",
  "nis_outp.sensation_numeric",
  "nis_outp.perceptual_function_numeric",
  "nis_outp.speech_and_language_numeric",
  "nis_outp.cognitive_function_numeric",
  "nis_outp.behaviour_numeric",
  "nis_outp.mood_numeric",
  "nis_outp.seeing_and_vision_numeric",
  "nis_outp.hearing_numeric",
  "nis_outp.pain_numeric",
  "nis_outp.fatigue_numeric",
  "nis_outp.other_numeric"
  )
```


Generate sumscores from questionnaire data and use mutate onto dat as new column
sumscores assumes that all items in the questionnaire have the SAME minimum and maximum scores for ALL items, ensure that this is correct before proceeding

When adding the column name for your sumscore use "questionnaire.score_name"

Generate sumscores and add as new column
```{r Generate sumscores}
dat <- dat %>% 
  mutate(
    nis.sum_score = 
         sumscores(input = dat,
                   sum_vars = sum_vars,
                   coding_keys = keys,
                   na_limit = 0,
                   min_item = 0,
                   max_item = 3,
                   min_score = 0,
                   max_score = 50
                   )
         )

```

# Create binary phenotypes
Add explanation of binary phenotype here:

Create numeric binary phenotype variable
```{r Numeric binary phenotype}
dat <- dat %>%
  mutate(
    questionnaire.phenotype_numeric =
      case_when(
        questionnaire.sum_score >= ~ 1,
        questionnaire.sum_score < ~ 0
      )
  )
dat %>%
  select(questionnaire.phenotype_numeric) %>%
  tbl_summary()
```

Create categorical binary phenotype variable
```{r Categorical binary phenotype variable}
dat <- dat %>%
  mutate(
    questionnaire.phenotype =
      recode_factor(
        questionnaire.phenotype_numeric,
        "0" = "No Phenotype",
        "1" = "Phenotype"
      )
  )
dat %>%
  select(questionnaire.phenotype) %>%
  tbl_summary()
```

# Save cleaned data

Check colnames before exporting final dataset
```{r Check colnames}
colnames(dat)
```

# COVIDCNS
```{r Write cleaned COVIDCNS variables to a .rds file}
dat %>%
  saveRDS(
    file = paste0(ilovedata, "/data/latest_freeze/covidcns/location/questionnaire_covidcns_clean.rds")
    )
```
